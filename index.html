<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบออมทรัพย์นักเรียน - โรงเรียนบ้านกิ่วพร้าว</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- jQuery Validate -->
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Loading Overlay -->
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- html2canvas for image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary-color: #f9f7e8;
            --secondary-color: #f4e04d;
            --accent-color: #e6d835;
            --text-dark: #2c3e50;
            --border-color: #ddd;
        }
        
        * {
            font-family: 'Sarabun', sans-serif;
        }
        
        h1, h2, h3, h4, h5, h6, .navbar-brand {
            font-family: 'Kanit', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, #fff 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: 600;
            color: var(--text-dark) !important;
        }
        
        .nav-link {
            color: var(--text-dark) !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover, .nav-link.active {
            color: #fff !important;
            background-color: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            border: none;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 10px;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            border: none;
            border-radius: 10px;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            border: none;
            border-radius: 10px;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(244, 224, 77, 0.25);
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table thead th {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            color: var(--text-dark);
            font-weight: 600;
            border: none;
        }
        
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--accent-color) 100%);
            border-radius: 15px 15px 0 0;
            color: var(--text-dark);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #fff 0%, var(--primary-color) 100%);
            border-left: 5px solid var(--accent-color);
        }
        
        .school-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        
        .login-container {
            max-width: 400px;
            margin: 50px auto;
        }
        
        .hidden {
            display: none !important;
        }
        
        .pagination {
            justify-content: center;
        }
        
        .page-link {
            color: var(--text-dark);
            border-color: var(--border-color);
        }
        
        .page-link:hover {
            background-color: var(--primary-color);
            border-color: var(--accent-color);
        }
        
        .page-item.active .page-link {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--text-dark);
        }
        
        @media (max-width: 768px) {
            .school-logo {
                width: 60px;
                height: 60px;
            }
            
            .card {
                margin-bottom: 20px;
            }
            
            .table-responsive {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" alt="โรงเรียนบ้านกิ่วพร้าว" class="school-logo me-3">
                <div>
                    <div>ระบบออมทรัพย์นักเรียน</div>
                    <small>โรงเรียนบ้านกิ่วพร้าว</small>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showPage('dashboard')">
                            <img src="https://img.icons8.com/fluency/20/dashboard.png" class="me-1"> แดชบอร์ด
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('transaction')">
                            <img src="https://img.icons8.com/fluency/20/money-transfer.png" class="me-1"> ฝาก-ถอน
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('students')">
                            <img src="https://img.icons8.com/fluency/20/student-male.png" class="me-1"> รายชื่อนักเรียน
                        </a>
                    </li>
                    <li class="nav-item" id="loginNav">
                        <a class="nav-link" href="#" onclick="showLoginModal()">
                            <img src="https://img.icons8.com/fluency/20/key.png" class="me-1"> เข้าสู่ระบบ
                        </a>
                    </li>
                    <li class="nav-item hidden" id="logoutNav">
                        <a class="nav-link" href="#" onclick="logout()">
                            <img src="https://img.icons8.com/fluency/20/logout.png" class="me-1"> ออกจากระบบ
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <img src="https://img.icons8.com/fluency/24/dashboard.png" class="me-2">
                                แดshboard ระบบออมทรัพย์
                            </h5>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="filterType" onchange="updateDashboard()">
                                    <option value="all">ทั้งหมด</option>
                                    <option value="monthly">รายเดือน</option>
                                </select>
                                <select class="form-select hidden" id="monthFilter" onchange="updateDashboard()">
                                    <option value="1">มกราคม</option>
                                    <option value="2">กุมภาพันธ์</option>
                                    <option value="3">มีนาคม</option>
                                    <option value="4">เมษายน</option>
                                    <option value="5">พฤษภาคม</option>
                                    <option value="6">มิถุนายน</option>
                                    <option value="7">กรกฎาคม</option>
                                    <option value="8">สิงหาคม</option>
                                    <option value="9">กันยายน</option>
                                    <option value="10">ตุลาคม</option>
                                    <option value="11">พฤศจิกายน</option>
                                    <option value="12">ธันวาคม</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <canvas id="savingsChart" width="400" height="200"></canvas>
                                </div>
                                <div class="col-md-4">
                                    <div class="row">
                                        <div class="col-12 mb-3">
                                            <div class="card stats-card">
                                                <div class="card-body text-center">
                                                    <h6>ยอดรวมทั้งหมด</h6>
                                                    <h3 class="text-primary" id="totalAmount">0 บาท</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="card stats-card">
                                        <div class="card-body text-center">
                                            <img src="https://img.icons8.com/fluency/32/baby.png" class="mb-2">
                                            <h6>อนุบาล</h6>
                                            <h5 class="text-success" id="kindergartenAmount">0 บาท</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="card stats-card">
                                        <div class="card-body text-center">
                                            <img src="https://img.icons8.com/fluency/32/student-male.png" class="mb-2">
                                            <h6>ป.1</h6>
                                            <h5 class="text-success" id="grade1Amount">0 บาท</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="card stats-card">
                                        <div class="card-body text-center">
                                            <img src="https://img.icons8.com/fluency/32/student-male.png" class="mb-2">
                                            <h6>ป.2</h6>
                                            <h5 class="text-success" id="grade2Amount">0 บาท</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="card stats-card">
                                        <div class="card-body text-center">
                                            <img src="https://img.icons8.com/fluency/32/student-male.png" class="mb-2">
                                            <h6>ป.3</h6>
                                            <h5 class="text-success" id="grade3Amount">0 บาท</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="card stats-card">
                                        <div class="card-body text-center">
                                            <img src="https://img.icons8.com/fluency/32/student-male.png" class="mb-2">
                                            <h6>ป.4</h6>
                                            <h5 class="text-success" id="grade4Amount">0 บาท</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="card stats-card">
                                        <div class="card-body text-center">
                                            <img src="https://img.icons8.com/fluency/32/student-male.png" class="mb-2">
                                            <h6>ป.5</h6>
                                            <h5 class="text-success" id="grade5Amount">0 บาท</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="card stats-card">
                                        <div class="card-body text-center">
                                            <img src="https://img.icons8.com/fluency/32/student-male.png" class="mb-2">
                                            <h6>ป.6</h6>
                                            <h5 class="text-success" id="grade6Amount">0 บาท</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Page -->
        <div id="transactionPage" class="page hidden">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <img src="https://img.icons8.com/fluency/24/money-transfer.png" class="me-2">
                                ระบบฝาก-ถอนเงิน
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="loginRequired" class="text-center py-5">
                                <img src="https://img.icons8.com/fluency/64/lock.png" class="mb-3">
                                <h5>กรุณาเข้าสู่ระบบก่อนใช้งาน</h5>
                                <button class="btn btn-primary" onclick="showLoginModal()">เข้าสู่ระบบ</button>
                            </div>
                            
                            <div id="transactionContent" class="hidden">
                                <div class="row mb-4">
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-success w-100" onclick="showMigrateModal()">
                                            <img src="https://img.icons8.com/fluency/20/import.png" class="me-1"> ยกมา
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-primary w-100" onclick="showDepositModal()">
                                            <img src="https://img.icons8.com/fluency/20/plus.png" class="me-1"> ฝาก
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-warning w-100" onclick="showWithdrawModal()">
                                            <img src="https://img.icons8.com/fluency/20/minus.png" class="me-1"> ถอน
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-info w-100" onclick="showExportModal()">
                                            <img src="https://img.icons8.com/fluency/20/export.png" class="me-1"> Export
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>วันที่</th>
                                                <th>ชื่อนักเรียน</th>
                                                <th>ชั้น</th>
                                                <th>ประเภท</th>
                                                <th>จำนวนเงิน</th>
                                                <th>ยอดคงเหลือ</th>
                                                <th>การจัดการ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transactionTableBody">
                                        </tbody>
                                    </table>
                                </div>
                                
                                <nav>
                                    <ul class="pagination" id="transactionPagination">
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Page -->
        <div id="studentsPage" class="page hidden">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <img src="https://img.icons8.com/fluency/24/student-male.png" class="me-2">
                                รายชื่อนักเรียน
                            </h5>
                            <button class="btn btn-primary" onclick="showAddStudentModal()" id="addStudentBtn">
                                <img src="https://img.icons8.com/fluency/20/plus.png" class="me-1"> เพิ่มนักเรียน
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ลำดับ</th>
                                            <th>ชื่อ-นามสกุล</th>
                                            <th>ชั้น</th>
                                            <th>ยอดเงิน</th>
                                            <th>การจัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <nav>
                                <ul class="pagination" id="studentsPagination">
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <img src="https://img.icons8.com/fluency/24/key.png" class="me-2">
                        เข้าสู่ระบบ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">ชื่อผู้ใช้</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">รหัสผ่าน</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">เข้าสู่ระบบ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <img src="https://img.icons8.com/fluency/24/plus.png" class="me-2">
                        เพิ่มนักเรียน
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div id="studentInputs">
                            <!-- Student inputs will be generated here -->
                        </div>
                        <button type="submit" class="btn btn-primary w-100">บันทึก</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <img src="https://img.icons8.com/fluency/24/edit.png" class="me-2">
                        แก้ไขข้อมูลนักเรียน
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <div class="mb-3">
                            <label class="form-label">ชื่อ-นามสกุล</label>
                            <input type="text" class="form-control" id="editStudentName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ชั้น</label>
                            <select class="form-select" id="editStudentGrade" required>
                                <option value="">เลือกชั้น</option>
                                <option value="อนุบาล">อนุบาล</option>
                                <option value="ป.1">ป.1</option>
                                <option value="ป.2">ป.2</option>
                                <option value="ป.3">ป.3</option>
                                <option value="ป.4">ป.4</option>
                                <option value="ป.5">ป.5</option>
                                <option value="ป.6">ป.6</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">บันทึกการแก้ไข</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Migrate Modal -->
    <div class="modal fade" id="migrateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <img src="https://img.icons8.com/fluency/24/import.png" class="me-2">
                        ยกยอดเงินมา
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="migrateForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">วันที่ยกมา</label>
                                <input type="date" class="form-control" id="migrateDate" required>
                            </div>
                        </div>
                        <div id="migrateStudents">
                            <!-- Students list will be populated here -->
                        </div>
                        <button type="submit" class="btn btn-primary w-100">บันทึกการยกมา</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal fade" id="depositModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <img src="https://img.icons8.com/fluency/24/plus.png" class="me-2">
                        ฝากเงิน
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="depositForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">วันที่ฝาก</label>
                                <input type="date" class="form-control" id="depositDate" required>
                            </div>
                        </div>
                        <div id="depositStudents">
                            <!-- Students list will be populated here -->
                        </div>
                        <button type="submit" class="btn btn-primary w-100">บันทึกการฝาก</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal fade" id="withdrawModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <img src="https://img.icons8.com/fluency/24/minus.png" class="me-2">
                        ถอนเงิน
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="withdrawForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">วันที่ถอน</label>
                                <input type="date" class="form-control" id="withdrawDate" required>
                            </div>
                        </div>
                        <div id="withdrawStudents">
                            <!-- Students list will be populated here -->
                        </div>
                        <button type="submit" class="btn btn-warning w-100">บันทึกการถอน</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <img src="https://img.icons8.com/fluency/24/export.png" class="me-2">
                        Export ข้อมูล
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">วันที่เริ่มต้น</label>
                            <input type="date" class="form-control" id="exportStartDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">วันที่สิ้นสุด</label>
                            <input type="date" class="form-control" id="exportEndDate" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <button class="btn btn-success me-2" onclick="exportToImage()">
                                <img src="https://img.icons8.com/fluency/20/image.png" class="me-1"> Export รูปภาพ
                            </button>
                            <button class="btn btn-primary me-2" onclick="exportToExcel()">
                                <img src="https://img.icons8.com/fluency/20/microsoft-excel-2019.png" class="me-1"> Export Excel
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>ตัวอย่างข้อมูลที่จะ Export:</h6>
                        <div id="exportPreview" class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <!-- Preview table will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let currentUser = null;
        let studentsData = [];
        let transactionsData = [];
        let currentPage = 1;
        let itemsPerPage = 15;
        let studentsCurrentPage = 1;
        let studentsItemsPerPage = 20;
        let savingsChart = null;

        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby3Yyc5giZf26IWmVGP39f-tiWdN3jXDicfJ7h7ItjqO0L5OwyLFb1Ml_g-8k7UmJPK1g/exec';
        const SHEET_ID = '1au6aCgZ5CnVk6t8Gg804Y7Wn8ab0KKYOaR5BtefF1ew';

        // User credentials
        const users = {
            'P1': { password: 'p1123456', grade: 'ป.1', role: 'teacher' },
            'P2': { password: 'p2123456', grade: 'ป.2', role: 'teacher' },
            'P3': { password: 'p3123456', grade: 'ป.3', role: 'teacher' },
            'P4': { password: 'p4123456', grade: 'ป.4', role: 'teacher' },
            'P5': { password: 'p5123456', grade: 'ป.5', role: 'teacher' },
            'P6': { password: 'p6123456', grade: 'ป.6', role: 'teacher' },
            'K123': { password: 'k123123456', grade: 'อนุบาล', role: 'teacher' },
            'admin': { password: 'admin57030010', grade: 'all', role: 'admin' }
        };

        // Initialize
        $(document).ready(function() {
            loadData();
            updateDashboard();
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            $('#migrateDate, #depositDate, #withdrawDate, #exportStartDate, #exportEndDate').val(today);
            
            // Form validations
            $('#loginForm').validate({
                submitHandler: function(form) {
                    login();
                }
            });
            
            $('#addStudentForm').validate({
                submitHandler: function(form) {
                    addStudents();
                }
            });
            
            $('#editStudentForm').validate({
                submitHandler: function(form) {
                    editStudent();
                }
            });
            
            $('#migrateForm').validate({
                submitHandler: function(form) {
                    migrateBalances();
                }
            });
            
            $('#depositForm').validate({
                submitHandler: function(form) {
                    processDeposit();
                }
            });
            
            $('#withdrawForm').validate({
                submitHandler: function(form) {
                    processWithdraw();
                }
            });
        });

        // Page navigation
        function showPage(page) {
            $('.page').addClass('hidden');
            $('#' + page + 'Page').removeClass('hidden');
            
            $('.nav-link').removeClass('active');
            $(`a[onclick="showPage('${page}')"]`).addClass('active');
            
            if (page === 'students') {
                loadStudents();
            } else if (page === 'transaction') {
                loadTransactions();
            } else if (page === 'dashboard') {
                updateDashboard();
            }
        }

        // Login functionality
        function showLoginModal() {
            $('#loginModal').modal('show');
        }

        function login() {
            const username = $('#username').val();
            const password = $('#password').val();
            
            if (users[username] && users[username].password === password) {
                currentUser = {
                    username: username,
                    grade: users[username].grade,
                    role: users[username].role
                };
                
                $('#loginNav').addClass('hidden');
                $('#logoutNav').removeClass('hidden');
                $('#loginModal').modal('hide');
                $('#loginRequired').addClass('hidden');
                $('#transactionContent').removeClass('hidden');
                
                // Show/hide add student button based on login status
                if (currentUser) {
                    $('#addStudentBtn').removeClass('hidden');
                } else {
                    $('#addStudentBtn').addClass('hidden');
                }
                
                Swal.fire({
                    icon: 'success',
                    title: 'เข้าสู่ระบบสำเร็จ',
                    text: `ยินดีต้อนรับ ${username}`,
                    timer: 1500
                });
                
                loadTransactions();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'เข้าสู่ระบบไม่สำเร็จ',
                    text: 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง'
                });
            }
        }

        function logout() {
            currentUser = null;
            $('#loginNav').removeClass('hidden');
            $('#logoutNav').addClass('hidden');
            $('#loginRequired').removeClass('hidden');
            $('#transactionContent').addClass('hidden');
            $('#addStudentBtn').addClass('hidden');
            $('#username').val('');
            $('#password').val('');
            
            Swal.fire({
                icon: 'success',
                title: 'ออกจากระบบสำเร็จ',
                timer: 1500
            });
        }

        // Data loading functions
        async function loadData() {
            try {
                $('body').LoadingOverlay('show');
                
                const response = await fetch(`${SCRIPT_URL}?action=getData&sheetId=${SHEET_ID}`);
                const data = await response.json();
                
                if (data.success) {
                    studentsData = data.students || [];
                    transactionsData = data.transactions || [];
                } else {
                    console.error('Error loading data:', data.error);
                }
            } catch (error) {
                console.error('Error:', error);
            } finally {
                $('body').LoadingOverlay('hide');
            }
        }

        // Dashboard functions
        function updateDashboard() {
            const filterType = $('#filterType').val();
            const selectedMonth = $('#monthFilter').val();
            
            if (filterType === 'monthly') {
                $('#monthFilter').removeClass('hidden');
            } else {
                $('#monthFilter').addClass('hidden');
            }
            
            calculateTotals(filterType, selectedMonth);
            updateChart(filterType, selectedMonth);
        }

        function calculateTotals(filterType, selectedMonth) {
            let filteredTransactions = transactionsData;
            
            if (filterType === 'monthly' && selectedMonth) {
                filteredTransactions = transactionsData.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.getMonth() + 1 == selectedMonth;
                });
            }
            
            // Calculate totals by grade
            const totals = {
                'อนุบาล': 0,
                'ป.1': 0,
                'ป.2': 0,
                'ป.3': 0,
                'ป.4': 0,
                'ป.5': 0,
                'ป.6': 0
            };
            
            // Calculate current balances for each student
            const studentBalances = {};
            
            filteredTransactions.forEach(transaction => {
                const studentId = transaction.studentId;
                if (!studentBalances[studentId]) {
                    studentBalances[studentId] = 0;
                }
                
                if (transaction.type === 'ฝาก' || transaction.type === 'ยกมา') {
                    studentBalances[studentId] += parseFloat(transaction.amount);
                } else if (transaction.type === 'ถอน') {
                    studentBalances[studentId] -= parseFloat(transaction.amount);
                }
            });
            
            // Sum by grade
            Object.keys(studentBalances).forEach(studentId => {
                const student = studentsData.find(s => s.id == studentId);
                if (student && studentBalances[studentId] > 0) {
                    totals[student.grade] += studentBalances[studentId];
                }
            });
            
            // Update UI
            let grandTotal = 0;
            Object.keys(totals).forEach(grade => {
                const amount = totals[grade];
                grandTotal += amount;
                
                const gradeKey = grade === 'อนุบาล' ? 'kindergarten' : 
                               grade === 'ป.1' ? 'grade1' :
                               grade === 'ป.2' ? 'grade2' :
                               grade === 'ป.3' ? 'grade3' :
                               grade === 'ป.4' ? 'grade4' :
                               grade === 'ป.5' ? 'grade5' : 'grade6';
                
                $(`#${gradeKey}Amount`).text(amount.toLocaleString() + ' บาท');
            });
            
            $('#totalAmount').text(grandTotal.toLocaleString() + ' บาท');
        }

        function updateChart(filterType, selectedMonth) {
            const ctx = document.getElementById('savingsChart').getContext('2d');
            
            if (savingsChart) {
                savingsChart.destroy();
            }
            
            const grades = ['อนุบาล', 'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6'];
            const amounts = grades.map(grade => {
                const gradeKey = grade === 'อนุบาล' ? 'kindergarten' : 
                               grade === 'ป.1' ? 'grade1' :
                               grade === 'ป.2' ? 'grade2' :
                               grade === 'ป.3' ? 'grade3' :
                               grade === 'ป.4' ? 'grade4' :
                               grade === 'ป.5' ? 'grade5' : 'grade6';
                
                const text = $(`#${gradeKey}Amount`).text();
                return parseFloat(text.replace(/[^\d]/g, '')) || 0;
            });
            
            savingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: grades,
                    datasets: [{
                        label: 'ยอดเงินออม (บาท)',
                        data: amounts,
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40',
                            '#FF6384'
                        ],
                        borderColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40',
                            '#FF6384'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'แผนภูมิยอดเงินออมแยกตามชั้น'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' บาท';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Students management
        function loadStudents() {
            const startIndex = (studentsCurrentPage - 1) * studentsItemsPerPage;
            const endIndex = startIndex + studentsItemsPerPage;
            const pageStudents = studentsData.slice(startIndex, endIndex);
            
            let html = '';
            pageStudents.forEach((student, index) => {
                const balance = calculateStudentBalance(student.id);
                html += `
                    <tr>
                        <td>${startIndex + index + 1}</td>
                        <td>${student.name}</td>
                        <td>${student.grade}</td>
                        <td>${balance.toLocaleString()} บาท</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editStudentModal('${student.id}')" ${!currentUser ? 'disabled' : ''}>
                                <img src="https://img.icons8.com/fluency/16/edit.png"> แก้ไข
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.id}')" ${!currentUser ? 'disabled' : ''}>
                                <img src="https://img.icons8.com/fluency/16/delete.png"> ลบ
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            $('#studentsTableBody').html(html);
            updateStudentsPagination();
        }

        function calculateStudentBalance(studentId) {
            let balance = 0;
            transactionsData.forEach(transaction => {
                if (transaction.studentId == studentId) {
                    if (transaction.type === 'ฝาก' || transaction.type === 'ยกมา') {
                        balance += parseFloat(transaction.amount);
                    } else if (transaction.type === 'ถอน') {
                        balance -= parseFloat(transaction.amount);
                    }
                }
            });
            return balance;
        }

        function updateStudentsPagination() {
            const totalPages = Math.ceil(studentsData.length / studentsItemsPerPage);
            let html = '';
            
            // Previous button
            html += `<li class="page-item ${studentsCurrentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changeStudentsPage(${studentsCurrentPage - 1})">ก่อนหน้า</a>
                     </li>`;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item ${i === studentsCurrentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changeStudentsPage(${i})">${i}</a>
                         </li>`;
            }
            
            // Next button
            html += `<li class="page-item ${studentsCurrentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changeStudentsPage(${studentsCurrentPage + 1})">ถัดไป</a>
                     </li>`;
            
            $('#studentsPagination').html(html);
        }

        function changeStudentsPage(page) {
            const totalPages = Math.ceil(studentsData.length / studentsItemsPerPage);
            if (page >= 1 && page <= totalPages) {
                studentsCurrentPage = page;
                loadStudents();
            }
        }

        function showAddStudentModal() {
            if (!currentUser) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเข้าสู่ระบบ',
                    text: 'คุณต้องเข้าสู่ระบบก่อนเพิ่มนักเรียน'
                });
                return;
            }
            
            let html = '';
            for (let i = 1; i <= 10; i++) {
                html += `
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label">ชื่อ-นามสกุล นักเรียนคนที่ ${i}</label>
                            <input type="text" class="form-control" name="studentName${i}" placeholder="ชื่อ-นามสกุล">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ชั้น</label>
                            <select class="form-select" name="studentGrade${i}">
                                <option value="">เลือกชั้น</option>
                                <option value="อนุบาล">อนุบาล</option>
                                <option value="ป.1">ป.1</option>
                                <option value="ป.2">ป.2</option>
                                <option value="ป.3">ป.3</option>
                                <option value="ป.4">ป.4</option>
                                <option value="ป.5">ป.5</option>
                                <option value="ป.6">ป.6</option>
                            </select>
                        </div>
                    </div>
                `;
            }
            
            $('#studentInputs').html(html);
            $('#addStudentModal').modal('show');
        }

        async function addStudents() {
            const students = [];
            
            for (let i = 1; i <= 10; i++) {
                const name = $(`input[name="studentName${i}"]`).val().trim();
                const grade = $(`select[name="studentGrade${i}"]`).val();
                
                if (name && grade) {
                    students.push({
                        name: name,
                        grade: grade
                    });
                }
            }
            
            if (students.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'กรุณากรอกข้อมูลนักเรียนอย่างน้อย 1 คน'
                });
                return;
            }
            
            try {
                $('body').LoadingOverlay('show');
                
                const params = new URLSearchParams();
                params.append('action', 'addStudents');
                params.append('sheetId', SHEET_ID);
                params.append('students', JSON.stringify(students));
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'เพิ่มนักเรียนสำเร็จ',
                        text: `เพิ่มนักเรียน ${students.length} คน`
                    });
                    
                    $('#addStudentModal').modal('hide');
                    await loadData();
                    loadStudents();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            } finally {
                $('body').LoadingOverlay('hide');
            }
        }

        function editStudentModal(studentId) {
            const student = studentsData.find(s => s.id == studentId);
            if (student) {
                $('#editStudentId').val(student.id);
                $('#editStudentName').val(student.name);
                $('#editStudentGrade').val(student.grade);
                $('#editStudentModal').modal('show');
            }
        }

        async function editStudent() {
            const studentId = $('#editStudentId').val();
            const name = $('#editStudentName').val();
            const grade = $('#editStudentGrade').val();
            
            try {
                $('body').LoadingOverlay('show');
                
                const params = new URLSearchParams();
                params.append('action', 'editStudent');
                params.append('sheetId', SHEET_ID);
                params.append('studentId', studentId);
                params.append('name', name);
                params.append('grade', grade);
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'แก้ไขสำเร็จ',
                        timer: 1500
                    });
                    
                    $('#editStudentModal').modal('hide');
                    await loadData();
                    loadStudents();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            } finally {
                $('body').LoadingOverlay('hide');
            }
        }

        async function deleteStudent(studentId) {
            const student = studentsData.find(s => s.id == studentId);
            
            const result = await Swal.fire({
                title: 'ยืนยันการลบ',
                text: `คุณต้องการลบ ${student.name} ใช่หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            });
            
            if (result.isConfirmed) {
                try {
                    $('body').LoadingOverlay('show');
                    
                    const params = new URLSearchParams();
                    params.append('action', 'deleteStudent');
                    params.append('sheetId', SHEET_ID);
                    params.append('studentId', studentId);
                    
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: params
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'ลบสำเร็จ',
                            timer: 1500
                        });
                        
                        await loadData();
                        loadStudents();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: error.message
                    });
                } finally {
                    $('body').LoadingOverlay('hide');
                }
            }
        }

        // Transaction management
        function loadTransactions() {
            if (!currentUser) return;
            
            let filteredTransactions = transactionsData;
            
            // Filter by user's grade if not admin
            if (currentUser.role !== 'admin') {
                filteredTransactions = transactionsData.filter(t => {
                    const student = studentsData.find(s => s.id == t.studentId);
                    return student && student.grade === currentUser.grade;
                });
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            let html = '';
            pageTransactions.forEach(transaction => {
                const student = studentsData.find(s => s.id == transaction.studentId);
                const studentName = student ? student.name : 'ไม่พบข้อมูล';
                const studentGrade = student ? student.grade : '-';
                
                html += `
                    <tr>
                        <td>${formatThaiDate(transaction.date)}</td>
                        <td>${studentName}</td>
                        <td>${studentGrade}</td>
                        <td><span class="badge bg-${transaction.type === 'ฝาก' ? 'success' : transaction.type === 'ถอน' ? 'warning' : 'info'}">${transaction.type}</span></td>
                        <td>${parseFloat(transaction.amount).toLocaleString()} บาท</td>
                        <td>${parseFloat(transaction.balance).toLocaleString()} บาท</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editTransaction('${transaction.id}')">
                                <img src="https://img.icons8.com/fluency/16/edit.png"> แก้ไข
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${transaction.id}')">
                                <img src="https://img.icons8.com/fluency/16/delete.png"> ลบ
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            $('#transactionTableBody').html(html);
            updateTransactionPagination(filteredTransactions.length);
        }

        function updateTransactionPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            let html = '';
            
            // Previous button
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changeTransactionPage(${currentPage - 1})">ก่อนหน้า</a>
                     </li>`;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changeTransactionPage(${i})">${i}</a>
                         </li>`;
            }
            
            // Next button
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changeTransactionPage(${currentPage + 1})">ถัดไป</a>
                     </li>`;
            
            $('#transactionPagination').html(html);
        }

        function changeTransactionPage(page) {
            let filteredTransactions = transactionsData;
            
            if (currentUser.role !== 'admin') {
                filteredTransactions = transactionsData.filter(t => {
                    const student = studentsData.find(s => s.id == t.studentId);
                    return student && student.grade === currentUser.grade;
                });
            }
            
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadTransactions();
            }
        }

        // Migrate functionality
        function showMigrateModal() {
            let students = studentsData;
            
            // Filter by user's grade if not admin
            if (currentUser.role !== 'admin') {
                students = studentsData.filter(s => s.grade === currentUser.grade);
            }
            
            let html = '';
            students.forEach(student => {
                html += `
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label">${student.name} (${student.grade})</label>
                        </div>
                        <div class="col-md-6">
                            <input type="number" class="form-control" name="migrate_${student.id}" placeholder="จำนวนเงินเริ่มต้น" min="0" step="0.01">
                        </div>
                    </div>
                `;
            });
            
            $('#migrateStudents').html(html);
            $('#migrateModal').modal('show');
        }

        async function migrateBalances() {
            const date = $('#migrateDate').val();
            const transactions = [];
            
            studentsData.forEach(student => {
                const amount = parseFloat($(`input[name="migrate_${student.id}"]`).val()) || 0;
                if (amount > 0) {
                    transactions.push({
                        studentId: student.id,
                        type: 'ยกมา',
                        amount: amount,
                        date: date,
                        balance: amount
                    });
                }
            });
            
            if (transactions.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'กรุณากรอกจำนวนเงินอย่างน้อย 1 รายการ'
                });
                return;
            }
            
            try {
                $('body').LoadingOverlay('show');
                
                const params = new URLSearchParams();
                params.append('action', 'addTransactions');
                params.append('sheetId', SHEET_ID);
                params.append('transactions', JSON.stringify(transactions));
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'ยกยอดสำเร็จ',
                        text: `ยกยอดเงิน ${transactions.length} รายการ`
                    });
                    
                    $('#migrateModal').modal('hide');
                    await loadData();
                    loadTransactions();
                    updateDashboard();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            } finally {
                $('body').LoadingOverlay('hide');
            }
        }

        // Deposit functionality
        function showDepositModal() {
            let students = studentsData;
            
            // Filter by user's grade if not admin
            if (currentUser.role !== 'admin') {
                students = studentsData.filter(s => s.grade === currentUser.grade);
            }
            
            let html = '';
            students.forEach(student => {
                const currentBalance = calculateStudentBalance(student.id);
                html += `
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label">${student.name} (${student.grade}) - ยอดคงเหลือ: ${currentBalance.toLocaleString()} บาท</label>
                        </div>
                        <div class="col-md-6">
                            <input type="number" class="form-control" name="deposit_${student.id}" placeholder="จำนวนเงินฝาก" min="0" step="0.01">
                        </div>
                    </div>
                `;
            });
            
            $('#depositStudents').html(html);
            $('#depositModal').modal('show');
        }

        async function processDeposit() {
            const date = $('#depositDate').val();
            const transactions = [];
            
            studentsData.forEach(student => {
                const amount = parseFloat($(`input[name="deposit_${student.id}"]`).val()) || 0;
                if (amount > 0) {
                    const currentBalance = calculateStudentBalance(student.id);
                    const newBalance = currentBalance + amount;
                    
                    transactions.push({
                        studentId: student.id,
                        type: 'ฝาก',
                        amount: amount,
                        date: date,
                        balance: newBalance
                    });
                }
            });
            
            if (transactions.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'กรุณากรอกจำนวนเงินอย่างน้อย 1 รายการ'
                });
                return;
            }
            
            try {
                $('body').LoadingOverlay('show');
                
                const params = new URLSearchParams();
                params.append('action', 'addTransactions');
                params.append('sheetId', SHEET_ID);
                params.append('transactions', JSON.stringify(transactions));
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'ฝากเงินสำเร็จ',
                        text: `ฝากเงิน ${transactions.length} รายการ`
                    });
                    
                    $('#depositModal').modal('hide');
                    await loadData();
                    loadTransactions();
                    updateDashboard();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            } finally {
                $('body').LoadingOverlay('hide');
            }
        }

        // Withdraw functionality
        function showWithdrawModal() {
            let students = studentsData;
            
            // Filter by user's grade if not admin
            if (currentUser.role !== 'admin') {
                students = studentsData.filter(s => s.grade === currentUser.grade);
            }
            
            let html = '';
            students.forEach(student => {
                const currentBalance = calculateStudentBalance(student.id);
                html += `
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label">${student.name} (${student.grade}) - ยอดคงเหลือ: ${currentBalance.toLocaleString()} บาท</label>
                        </div>
                        <div class="col-md-6">
                            <input type="number" class="form-control" name="withdraw_${student.id}" placeholder="จำนวนเงินถอน" min="0" max="${currentBalance}" step="0.01">
                        </div>
                    </div>
                `;
            });
            
            $('#withdrawStudents').html(html);
            $('#withdrawModal').modal('show');
        }

        async function processWithdraw() {
            const date = $('#withdrawDate').val();
            const transactions = [];
            
            studentsData.forEach(student => {
                const amount = parseFloat($(`input[name="withdraw_${student.id}"]`).val()) || 0;
                if (amount > 0) {
                    const currentBalance = calculateStudentBalance(student.id);
                    
                    if (amount > currentBalance) {
                        Swal.fire({
                            icon: 'error',
                            title: 'จำนวนเงินไม่เพียงพอ',
                            text: `${student.name} มียอดคงเหลือ ${currentBalance.toLocaleString()} บาท`
                        });
                        return;
                    }
                    
                    const newBalance = currentBalance - amount;
                    
                    transactions.push({
                        studentId: student.id,
                        type: 'ถอน',
                        amount: amount,
                        date: date,
                        balance: newBalance
                    });
                }
            });
            
            if (transactions.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'กรุณากรอกจำนวนเงินอย่างน้อย 1 รายการ'
                });
                return;
            }
            
            try {
                $('body').LoadingOverlay('show');
                
                const params = new URLSearchParams();
                params.append('action', 'addTransactions');
                params.append('sheetId', SHEET_ID);
                params.append('transactions', JSON.stringify(transactions));
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'ถอนเงินสำเร็จ',
                        text: `ถอนเงิน ${transactions.length} รายการ`
                    });
                    
                    $('#withdrawModal').modal('hide');
                    await loadData();
                    loadTransactions();
                    updateDashboard();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            } finally {
                $('body').LoadingOverlay('hide');
            }
        }

        // Export functionality
        function showExportModal() {
            $('#exportModal').modal('show');
            updateExportPreview();
        }

        function updateExportPreview() {
            const startDate = $('#exportStartDate').val();
            const endDate = $('#exportEndDate').val();
            
            if (!startDate || !endDate) return;
            
            const exportData = generateExportData(startDate, endDate);
            
            let html = `
                <div class="text-center mb-3">
                    <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" width="60" height="60">
                    <h6>โรงเรียนบ้านกิ่วพร้าว</h6>
                    <p>รายงานการออมเงิน ระหว่างวันที่ ${formatThaiDate(startDate)} ถึง ${formatThaiDate(endDate)}</p>
                </div>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>ลำดับ</th>
                            <th>ชื่อ-นามสกุล</th>
            `;
            
            // Add date columns
            exportData.dates.forEach(date => {
                html += `<th>${formatThaiDate(date)}</th>`;
            });
            
            html += `
                            <th>ยอดรวมตามช่วงวันที่</th>
                            <th>ยอดรวมทั้งหมด</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Add data rows
            exportData.rows.forEach((row, index) => {
                html += `<tr>
                    <td>${index + 1}</td>
                    <td>${row.name}</td>
                `;
                
                exportData.dates.forEach(date => {
                    const amount = row.amounts[date] || 0;
                    html += `<td>${amount.toLocaleString()}</td>`;
                });
                
                html += `
                    <td>${row.periodTotal.toLocaleString()}</td>
                    <td>${row.grandTotal.toLocaleString()}</td>
                </tr>`;
            });
            
            // Add totals row
            html += `<tr class="table-warning">
                <td colspan="2"><strong>รวมทั้งสิ้น</strong></td>
            `;
            
            exportData.dates.forEach(date => {
                const total = exportData.rows.reduce((sum, row) => sum + (row.amounts[date] || 0), 0);
                html += `<td><strong>${total.toLocaleString()}</strong></td>`;
            });
            
            const periodGrandTotal = exportData.rows.reduce((sum, row) => sum + row.periodTotal, 0);
            const overallGrandTotal = exportData.rows.reduce((sum, row) => sum + row.grandTotal, 0);
            
            html += `
                <td><strong>${periodGrandTotal.toLocaleString()}</strong></td>
                <td><strong>${overallGrandTotal.toLocaleString()}</strong></td>
            </tr>
            `;
            
            html += `</tbody></table>`;
            
            $('#exportPreview').html(html);
        }

        function generateExportData(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Generate date range
            const dates = [];
            const currentDate = new Date(start);
            while (currentDate <= end) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            let students = studentsData;
            
            // Filter by user's grade if not admin
            if (currentUser.role !== 'admin') {
                students = studentsData.filter(s => s.grade === currentUser.grade);
            }
            
            const rows = [];
            
            if (currentUser.role === 'admin') {
                // For admin, group by grade
                const grades = ['อนุบาล', 'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6'];
                
                grades.forEach(grade => {
                    const gradeStudents = students.filter(s => s.grade === grade);
                    if (gradeStudents.length > 0) {
                        const amounts = {};
                        let periodTotal = 0;
                        let grandTotal = 0;
                        
                        dates.forEach(date => {
                            let dayTotal = 0;
                            gradeStudents.forEach(student => {
                                const studentTransactions = transactionsData.filter(t => 
                                    t.studentId == student.id && t.date === date
                                );
                                
                                studentTransactions.forEach(t => {
                                    if (t.type === 'ฝาก' || t.type === 'ยกมา') {
                                        dayTotal += parseFloat(t.amount);
                                    }
                                });
                            });
                            amounts[date] = dayTotal;
                            periodTotal += dayTotal;
                        });
                        
                        // Calculate grand total for this grade
                        gradeStudents.forEach(student => {
                            grandTotal += calculateStudentBalance(student.id);
                        });
                        
                        rows.push({
                            name: grade,
                            amounts: amounts,
                            periodTotal: periodTotal,
                            grandTotal: grandTotal
                        });
                    }
                });
            } else {
                // For teachers, show individual students
                students.forEach(student => {
                    const amounts = {};
                    let periodTotal = 0;
                    
                    dates.forEach(date => {
                        const studentTransactions = transactionsData.filter(t => 
                            t.studentId == student.id && t.date === date
                        );
                        
                        let dayTotal = 0;
                        studentTransactions.forEach(t => {
                            if (t.type === 'ฝาก' || t.type === 'ยกมา') {
                                dayTotal += parseFloat(t.amount);
                            }
                        });
                        
                        amounts[date] = dayTotal;
                        periodTotal += dayTotal;
                    });
                    
                    const grandTotal = calculateStudentBalance(student.id);
                    
                    rows.push({
                        name: student.name,
                        amounts: amounts,
                        periodTotal: periodTotal,
                        grandTotal: grandTotal
                    });
                });
            }
            
            return {
                dates: dates,
                rows: rows
            };
        }

        async function exportToImage() {
            const startDate = $('#exportStartDate').val();
            const endDate = $('#exportEndDate').val();
            
            if (!startDate || !endDate) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกวันที่',
                    text: 'กรุณาเลือกช่วงวันที่ที่ต้องการ Export'
                });
                return;
            }
            
            try {
                $('body').LoadingOverlay('show');
                
                const element = document.getElementById('exportPreview');
                
                // Set specific dimensions for A4 landscape (29.7cm width)
                const canvas = await html2canvas(element, {
                    scale: 3,
                    useCORS: true,
                    allowTaint: true,
                    width: 1123, // 29.7cm at 96 DPI
                    height: element.scrollHeight,
                    scrollX: 0,
                    scrollY: 0
                });
                
                // Convert canvas to blob
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `รายงานการออมเงิน_${startDate}_${endDate}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 'image/png');
                
                Swal.fire({
                    icon: 'success',
                    title: 'Export สำเร็จ',
                    text: 'ไฟล์รูปภาพถูกดาวน์โหลดแล้ว'
                });
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            } finally {
                $('body').LoadingOverlay('hide');
            }
        }

        async function exportToExcel() {
            const startDate = $('#exportStartDate').val();
            const endDate = $('#exportEndDate').val();
            
            if (!startDate || !endDate) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกวันที่',
                    text: 'กรุณาเลือกช่วงวันที่ที่ต้องการ Export'
                });
                return;
            }
            
            try {
                $('body').LoadingOverlay('show');
                
                const exportData = generateExportData(startDate, endDate);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Prepare data for Excel
                const wsData = [];
                
                // Header info
                wsData.push(['โรงเรียนบ้านกิ่วพร้าว']);
                wsData.push([`รายงานการออมเงิน ระหว่างวันที่ ${formatThaiDate(startDate)} ถึง ${formatThaiDate(endDate)}`]);
                wsData.push([]);
                
                // Table headers
                const headers = ['ลำดับ', 'ชื่อ-นามสกุล'];
                exportData.dates.forEach(date => {
                    headers.push(formatThaiDate(date));
                });
                headers.push('ยอดรวมตามช่วงวันที่', 'ยอดรวมทั้งหมด');
                wsData.push(headers);
                
                // Data rows
                exportData.rows.forEach((row, index) => {
                    const rowData = [index + 1, row.name];
                    exportData.dates.forEach(date => {
                        rowData.push(row.amounts[date] || 0);
                    });
                    rowData.push(row.periodTotal, row.grandTotal);
                    wsData.push(rowData);
                });
                
                // Totals row
                const totalsRow = ['', 'รวมทั้งสิ้น'];
                exportData.dates.forEach(date => {
                    const total = exportData.rows.reduce((sum, row) => sum + (row.amounts[date] || 0), 0);
                    totalsRow.push(total);
                });
                const periodGrandTotal = exportData.rows.reduce((sum, row) => sum + row.periodTotal, 0);
                const overallGrandTotal = exportData.rows.reduce((sum, row) => sum + row.grandTotal, 0);
                totalsRow.push(periodGrandTotal, overallGrandTotal);
                wsData.push(totalsRow);
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Add to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'รายงานการออมเงิน');
                
                // Generate buffer and create blob
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });
                
                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `รายงานการออมเงิน_${startDate}_${endDate}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                Swal.fire({
                    icon: 'success',
                    title: 'Export สำเร็จ',
                    text: 'ไฟล์ Excel ถูกดาวน์โหลดแล้ว'
                });
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            } finally {
                $('body').LoadingOverlay('hide');
            }
        }

        // Utility functions
        function formatThaiDate(dateString) {
            const date = new Date(dateString);
            const months = [
                'ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
                'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'
            ];
            
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear() + 543;
            
            return `${day} ${month} ${year.toString().substr(-2)}`;
        }

        // Event listeners for export date changes
        $('#exportStartDate, #exportEndDate').on('change', updateExportPreview);

        // Transaction edit/delete functions (placeholder)
        function editTransaction(transactionId) {
            Swal.fire({
                icon: 'info',
                title: 'ฟีเจอร์ยังไม่พร้อม',
                text: 'การแก้ไขรายการจะพัฒนาในเวอร์ชันถัดไป'
            });
        }

        async function deleteTransaction(transactionId) {
            const result = await Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบรายการนี้ใช่หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            });
            
            if (result.isConfirmed) {
                try {
                    $('body').LoadingOverlay('show');
                    
                    const params = new URLSearchParams();
                    params.append('action', 'deleteTransaction');
                    params.append('sheetId', SHEET_ID);
                    params.append('transactionId', transactionId);
                    
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: params
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'ลบสำเร็จ',
                            timer: 1500
                        });
                        
                        await loadData();
                        loadTransactions();
                        updateDashboard();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: error.message
                    });
                } finally {
                    $('body').LoadingOverlay('hide');
                }
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9655b236f52f2dbc',t:'MTc1MzU1MTc3My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
