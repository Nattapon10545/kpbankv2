<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบออมทรัพย์นักเรียน - โรงเรียนบ้านกิ่วพร้าว</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons8 -->
    <link rel="stylesheet" href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- jQuery Validate -->
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- html2canvas for image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #F5E6A3;
            --secondary-color: #F0D878;
            --accent-color: #E8C547;
            --text-dark: #2C3E50;
            --success-color: #27AE60;
            --danger-color: #E74C3C;
            --warning-color: #F39C12;
        }

        * {
            font-family: 'Sarabun', sans-serif;
        }

        h1, h2, h3, h4, h5, h6, .navbar-brand {
            font-family: 'Kanit', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #F5E6A3 0%, #F0D878 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        .navbar {
            background: rgba(245, 230, 163, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 600;
            color: var(--text-dark) !important;
        }

        .nav-link {
            color: var(--text-dark) !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--accent-color) !important;
            transform: translateY(-2px);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--secondary-color), var(--accent-color));
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(232, 197, 71, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success-color), #2ECC71);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 500;
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger-color), #C0392B);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 500;
        }

        .btn-warning {
            background: linear-gradient(45deg, var(--warning-color), #E67E22);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 500;
        }

        .form-control {
            border-radius: 10px;
            border: 2px solid #E8E8E8;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(232, 197, 71, 0.25);
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .table thead th {
            background: linear-gradient(45deg, var(--secondary-color), var(--accent-color));
            color: var(--text-dark);
            font-weight: 600;
            border: none;
        }

        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(45deg, var(--secondary-color), var(--accent-color));
            color: var(--text-dark);
            border-radius: 15px 15px 0 0;
        }

        .stats-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(245,230,163,0.3));
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-color);
            font-family: 'Kanit', sans-serif;
        }

        .stats-label {
            font-size: 1.1rem;
            color: var(--text-dark);
            font-weight: 500;
        }

        .school-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-right: 15px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .export-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            background: white;
        }

        @media (max-width: 768px) {
            .stats-number {
                font-size: 2rem;
            }
            
            .school-logo {
                width: 60px;
                height: 60px;
            }
            
            .card {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" alt="โรงเรียนบ้านกิ่วพร้าว" class="school-logo">
                <span>ระบบออมทรัพย์นักเรียน</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showPage('dashboard')">
                            <i class="las la-chart-bar"></i> แดชบอร์ด
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('transaction')">
                            <i class="las la-exchange-alt"></i> ฝาก-ถอน
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('students')">
                            <i class="las la-users"></i> รายชื่อนักเรียน
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item" id="loginNav">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">
                            <i class="las la-sign-in-alt"></i> เข้าสู่ระบบ
                        </a>
                    </li>
                    <li class="nav-item" id="logoutNav" style="display: none;">
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="las la-sign-out-alt"></i> ออกจากระบบ
                        </a>
                    </li>
                    <li class="nav-item" id="userInfo" style="display: none;">
                        <span class="navbar-text">
                            <i class="las la-user"></i> <span id="currentUser"></span>
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page-section active">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" alt="โรงเรียนบ้านกิ่วพร้าว" class="school-logo">
                            <h2 class="card-title">ระบบออมทรัพย์นักเรียน</h2>
                            <h4 class="text-muted">โรงเรียนบ้านกิ่วพร้าว</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">ตัวกรองข้อมูล</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <select class="form-control" id="filterType" onchange="updateDashboard()">
                                        <option value="all">ทั้งหมด</option>
                                        <option value="monthly">รายเดือน</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <input type="month" class="form-control" id="filterMonth" onchange="updateDashboard()" style="display: none;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card">
                        <div class="stats-number" id="totalAmount">0</div>
                        <div class="stats-label">ยอดรวมทั้งหมด (บาท)</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card">
                        <div class="stats-number" id="kindergartenAmount">0</div>
                        <div class="stats-label">อนุบาล (บาท)</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card">
                        <div class="stats-number" id="grade1Amount">0</div>
                        <div class="stats-label">ป.1 (บาท)</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card">
                        <div class="stats-number" id="grade2Amount">0</div>
                        <div class="stats-label">ป.2 (บาท)</div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card">
                        <div class="stats-number" id="grade3Amount">0</div>
                        <div class="stats-label">ป.3 (บาท)</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card">
                        <div class="stats-number" id="grade4Amount">0</div>
                        <div class="stats-label">ป.4 (บาท)</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card">
                        <div class="stats-number" id="grade5Amount">0</div>
                        <div class="stats-label">ป.5 (บาท)</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card">
                        <div class="stats-number" id="grade6Amount">0</div>
                        <div class="stats-label">ป.6 (บาท)</div>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">แผนภูมิยอดเงินฝากรายชั้น</h5>
                            <canvas id="savingsChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Page -->
        <div id="transactionPage" class="page-section">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">ระบบฝาก-ถอนเงิน</h4>
                            <div id="loginRequired" class="alert alert-warning">
                                <i class="las la-exclamation-triangle"></i>
                                กรุณาเข้าสู่ระบบเพื่อใช้งานระบบฝาก-ถอนเงิน
                            </div>
                            
                            <div id="transactionControls" style="display: none;">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <button class="btn btn-success w-100" onclick="showMigrateModal()">
                                            <i class="las la-arrow-right"></i> ยกมา
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-primary w-100" onclick="showDepositModal()">
                                            <i class="las la-plus"></i> ฝาก
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-warning w-100" onclick="showWithdrawModal()">
                                            <i class="las la-minus"></i> ถอน
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-info w-100" onclick="showExportModal()">
                                            <i class="las la-download"></i> Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">ประวัติการทำรายการ</h5>
                            <div class="table-responsive">
                                <table class="table table-striped" id="transactionTable">
                                    <thead>
                                        <tr>
                                            <th>วันที่</th>
                                            <th>ชื่อนักเรียน</th>
                                            <th>ชั้น</th>
                                            <th>ประเภท</th>
                                            <th>จำนวนเงิน</th>
                                            <th>ยอดคงเหลือ</th>
                                            <th>การจัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionTableBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav>
                                <ul class="pagination justify-content-center" id="transactionPagination">
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Page -->
        <div id="studentsPage" class="page-section">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="card-title mb-0">รายชื่อนักเรียน</h4>
                                <button class="btn btn-primary" onclick="showAddStudentModal()" id="addStudentBtn" style="display: none;">
                                    <i class="las la-plus"></i> เพิ่มนักเรียน
                                </button>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped" id="studentsTable">
                                    <thead>
                                        <tr>
                                            <th>ลำดับ</th>
                                            <th>ชื่อ-นามสกุล</th>
                                            <th>ชั้น</th>
                                            <th>ยอดเงินปัจจุบัน</th>
                                            <th>การจัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody">
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav>
                                <ul class="pagination justify-content-center" id="studentsPagination">
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เข้าสู่ระบบ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">ชื่อผู้ใช้</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">รหัสผ่าน</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">เข้าสู่ระบบ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เพิ่มนักเรียน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div id="studentInputs">
                            <!-- Student inputs will be generated here -->
                        </div>
                        <button type="submit" class="btn btn-primary w-100">บันทึก</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Migrate Modal -->
    <div class="modal fade" id="migrateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ยกเงินมา</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="migrateForm">
                        <div class="mb-3">
                            <label class="form-label">วันที่ยกมา</label>
                            <input type="date" class="form-control" id="migrateDate" required>
                        </div>
                        <div id="migrateStudents">
                            <!-- Student list will be populated here -->
                        </div>
                        <button type="submit" class="btn btn-success w-100">บันทึก</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal fade" id="depositModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ฝากเงิน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="depositForm">
                        <div class="mb-3">
                            <label class="form-label">วันที่ฝาก</label>
                            <input type="date" class="form-control" id="depositDate" required>
                        </div>
                        <div id="depositStudents">
                            <!-- Student list will be populated here -->
                        </div>
                        <button type="submit" class="btn btn-primary w-100">บันทึก</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal fade" id="withdrawModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ถอนเงิน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="withdrawForm">
                        <div class="mb-3">
                            <label class="form-label">วันที่ถอน</label>
                            <input type="date" class="form-control" id="withdrawDate" required>
                        </div>
                        <div id="withdrawStudents">
                            <!-- Student list will be populated here -->
                        </div>
                        <button type="submit" class="btn btn-warning w-100">บันทึก</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Export ข้อมูล</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">วันที่เริ่มต้น</label>
                            <input type="date" class="form-control" id="exportStartDate">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">วันที่สิ้นสุด</label>
                            <input type="date" class="form-control" id="exportEndDate">
                        </div>
                    </div>
                    
                    <div class="row mb-3" id="adminExportOptions" style="display: none;">
                        <div class="col-md-12">
                            <label class="form-label">รูปแบบรายงาน</label>
                            <select class="form-control" id="exportFormat">
                                <option value="student">รายนักเรียน</option>
                                <option value="grade">รายชั้น</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <button class="btn btn-info w-100" onclick="generatePreview()">
                                <i class="las la-eye"></i> ดูตัวอย่าง
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="exportToExcel()">
                                <i class="las la-file-excel"></i> Export Excel
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="exportToImage()">
                                <i class="las la-image"></i> Export รูปภาพ
                            </button>
                        </div>
                    </div>
                    
                    <div id="exportPreview" class="export-preview" style="display: none;">
                        <!-- Preview will be shown here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">แก้ไขข้อมูลนักเรียน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <div class="mb-3">
                            <label class="form-label">ชื่อ-นามสกุล</label>
                            <input type="text" class="form-control" id="editStudentName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ชั้น</label>
                            <select class="form-control" id="editStudentGrade" required>
                                <option value="">เลือกชั้น</option>
                                <option value="อนุบาล">อนุบาล</option>
                                <option value="ป.1">ป.1</option>
                                <option value="ป.2">ป.2</option>
                                <option value="ป.3">ป.3</option>
                                <option value="ป.4">ป.4</option>
                                <option value="ป.5">ป.5</option>
                                <option value="ป.6">ป.6</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">บันทึก</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal fade" id="editTransactionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">แก้ไขรายการ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editTransactionForm">
                        <input type="hidden" id="editTransactionId">
                        <div class="mb-3">
                            <label class="form-label">วันที่</label>
                            <input type="date" class="form-control" id="editTransactionDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">จำนวนเงิน</label>
                            <input type="number" class="form-control" id="editTransactionAmount" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">บันทึก</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let currentUser = null;
        let currentUserRole = null;
        let studentsData = [];
        let transactionsData = [];
        let currentPage = 1;
        let itemsPerPage = 15;
        let studentsCurrentPage = 1;
        let studentsItemsPerPage = 20;
        let savingsChart = null;

        // API Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbxiX80HKUFaNgZSeHdkKvCCruUrFAFoKBv8m4oR8qIDi_Tc3KEaBBc8DKCHHG1UF3YWqQ/exec';
        const SHEET_ID = '11V7IsIv6HE9g7B6iz4kCya3tdVPtFGfY182zIu55OSY';

        // User credentials
        const users = {
            'P1': { password: 'p1123456', role: 'teacher', grade: 'ป.1' },
            'P2': { password: 'p2123456', role: 'teacher', grade: 'ป.2' },
            'P3': { password: 'p3123456', role: 'teacher', grade: 'ป.3' },
            'P4': { password: 'p4123456', role: 'teacher', grade: 'ป.4' },
            'P5': { password: 'p5123456', role: 'teacher', grade: 'ป.5' },
            'P6': { password: 'p6123456', role: 'teacher', grade: 'ป.6' },
            'K123': { password: 'k123123456', role: 'teacher', grade: 'อนุบาล' },
            'admin': { password: 'admin57030010', role: 'admin', grade: 'all' }
        };

        // Initialize
        $(document).ready(function() {
            loadData();
            setupEventHandlers();
            updateDashboard();
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            $('#migrateDate, #depositDate, #withdrawDate, #exportStartDate, #exportEndDate').val(today);
        });

        // Event Handlers
        function setupEventHandlers() {
            // Login form
            $('#loginForm').on('submit', function(e) {
                e.preventDefault();
                login();
            });

            // Add student form
            $('#addStudentForm').on('submit', function(e) {
                e.preventDefault();
                addStudents();
            });

            // Edit student form
            $('#editStudentForm').on('submit', function(e) {
                e.preventDefault();
                updateStudent();
            });

            // Edit transaction form
            $('#editTransactionForm').on('submit', function(e) {
                e.preventDefault();
                updateTransaction();
            });

            // Transaction forms
            $('#migrateForm').on('submit', function(e) {
                e.preventDefault();
                migrateStudents();
            });

            $('#depositForm').on('submit', function(e) {
                e.preventDefault();
                depositMoney();
            });

            $('#withdrawForm').on('submit', function(e) {
                e.preventDefault();
                withdrawMoney();
            });

            // Filter change
            $('#filterType').on('change', function() {
                if ($(this).val() === 'monthly') {
                    $('#filterMonth').show();
                } else {
                    $('#filterMonth').hide();
                }
            });
        }

        // Navigation
        function showPage(page) {
            $('.page-section').removeClass('active');
            $('#' + page + 'Page').addClass('active');
            
            $('.nav-link').removeClass('active');
            $(`a[onclick="showPage('${page}')"]`).addClass('active');
            
            if (page === 'transaction') {
                loadTransactions();
            } else if (page === 'students') {
                loadStudents();
            }
        }

        // Authentication
        function login() {
            const username = $('#username').val();
            const password = $('#password').val();
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                currentUserRole = users[username].role;
                
                $('#loginNav').hide();
                $('#logoutNav, #userInfo').show();
                $('#currentUser').text(username);
                $('#loginRequired').hide();
                $('#transactionControls').show();
                $('#addStudentBtn').show();
                
                $('#loginModal').modal('hide');
                $('#username, #password').val('');
                
                Swal.fire({
                    icon: 'success',
                    title: 'เข้าสู่ระบบสำเร็จ',
                    text: `ยินดีต้อนรับ ${username}`,
                    timer: 2000
                });
                
                loadTransactions();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'เข้าสู่ระบบไม่สำเร็จ',
                    text: 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง'
                });
            }
        }

        function logout() {
            currentUser = null;
            currentUserRole = null;
            
            $('#loginNav').show();
            $('#logoutNav, #userInfo').hide();
            $('#loginRequired').show();
            $('#transactionControls').hide();
            $('#addStudentBtn').hide();
            
            Swal.fire({
                icon: 'success',
                title: 'ออกจากระบบสำเร็จ',
                timer: 1500
            });
        }

        // Data Loading
        async function loadData() {
            showLoading();
            try {
                const response = await fetch(`${API_URL}?action=getData&sheetId=${SHEET_ID}`);
                const data = await response.json();
                
                if (data.success) {
                    studentsData = data.students || [];
                    transactionsData = data.transactions || [];
                    updateDashboard();
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
            hideLoading();
        }

        // Dashboard
        function updateDashboard() {
            const filterType = $('#filterType').val();
            const filterMonth = $('#filterMonth').val();
            
            let filteredTransactions = transactionsData;
            
            if (filterType === 'monthly' && filterMonth) {
                filteredTransactions = transactionsData.filter(t => {
                    const transactionDate = new Date(t.date);
                    const filterDate = new Date(filterMonth);
                    return transactionDate.getFullYear() === filterDate.getFullYear() &&
                           transactionDate.getMonth() === filterDate.getMonth();
                });
            }
            
            // Calculate totals by grade
            const totals = {
                'อนุบาล': 0,
                'ป.1': 0,
                'ป.2': 0,
                'ป.3': 0,
                'ป.4': 0,
                'ป.5': 0,
                'ป.6': 0
            };
            
            // Calculate current balances for each student
            studentsData.forEach(student => {
                let balance = 0;
                filteredTransactions
                    .filter(t => t.studentName === student.name)
                    .forEach(t => {
                        if (t.type === 'ฝาก' || t.type === 'ยกมา') {
                            balance += parseFloat(t.amount);
                        } else if (t.type === 'ถอน') {
                            balance -= parseFloat(t.amount);
                        }
                    });
                
                if (totals.hasOwnProperty(student.grade)) {
                    totals[student.grade] += balance;
                }
            });
            
            // Update stats cards
            const totalAmount = Object.values(totals).reduce((sum, val) => sum + val, 0);
            $('#totalAmount').text(totalAmount.toLocaleString());
            $('#kindergartenAmount').text(totals['อนุบาล'].toLocaleString());
            $('#grade1Amount').text(totals['ป.1'].toLocaleString());
            $('#grade2Amount').text(totals['ป.2'].toLocaleString());
            $('#grade3Amount').text(totals['ป.3'].toLocaleString());
            $('#grade4Amount').text(totals['ป.4'].toLocaleString());
            $('#grade5Amount').text(totals['ป.5'].toLocaleString());
            $('#grade6Amount').text(totals['ป.6'].toLocaleString());
            
            // Update chart
            updateChart(totals);
        }

        function updateChart(totals) {
            const ctx = document.getElementById('savingsChart').getContext('2d');
            
            if (savingsChart) {
                savingsChart.destroy();
            }
            
            savingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['อนุบาล', 'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6'],
                    datasets: [{
                        label: 'ยอดเงิน (บาท)',
                        data: Object.values(totals),
                        backgroundColor: [
                            'rgba(245, 230, 163, 0.8)',
                            'rgba(240, 216, 120, 0.8)',
                            'rgba(232, 197, 71, 0.8)',
                            'rgba(245, 230, 163, 0.8)',
                            'rgba(240, 216, 120, 0.8)',
                            'rgba(232, 197, 71, 0.8)',
                            'rgba(245, 230, 163, 0.8)'
                        ],
                        borderColor: [
                            'rgba(232, 197, 71, 1)',
                            'rgba(232, 197, 71, 1)',
                            'rgba(232, 197, 71, 1)',
                            'rgba(232, 197, 71, 1)',
                            'rgba(232, 197, 71, 1)',
                            'rgba(232, 197, 71, 1)',
                            'rgba(232, 197, 71, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' บาท';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Students Management
        function loadStudents() {
            const startIndex = (studentsCurrentPage - 1) * studentsItemsPerPage;
            const endIndex = startIndex + studentsItemsPerPage;
            const paginatedStudents = studentsData.slice(startIndex, endIndex);
            
            let html = '';
            paginatedStudents.forEach((student, index) => {
                const balance = calculateStudentBalance(student.name);
                html += `
                    <tr>
                        <td>${startIndex + index + 1}</td>
                        <td>${student.name}</td>
                        <td>${student.grade}</td>
                        <td>${balance.toLocaleString()} บาท</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editStudent('${student.id}')">
                                <i class="las la-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.id}')">
                                <i class="las la-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            $('#studentsTableBody').html(html);
            updateStudentsPagination();
        }

        function calculateStudentBalance(studentName) {
            let balance = 0;
            transactionsData
                .filter(t => t.studentName === studentName)
                .forEach(t => {
                    if (t.type === 'ฝาก' || t.type === 'ยกมา') {
                        balance += parseFloat(t.amount);
                    } else if (t.type === 'ถอน') {
                        balance -= parseFloat(t.amount);
                    }
                });
            return balance;
        }

        function updateStudentsPagination() {
            const totalPages = Math.ceil(studentsData.length / studentsItemsPerPage);
            let html = '';
            
            for (let i = 1; i <= totalPages; i++) {
                html += `
                    <li class="page-item ${i === studentsCurrentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changeStudentsPage(${i})">${i}</a>
                    </li>
                `;
            }
            
            $('#studentsPagination').html(html);
        }

        function changeStudentsPage(page) {
            studentsCurrentPage = page;
            loadStudents();
        }

        function showAddStudentModal() {
            if (!currentUser) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเข้าสู่ระบบ',
                    text: 'คุณต้องเข้าสู่ระบบก่อนเพื่อเพิ่มนักเรียน'
                });
                return;
            }
            
            let html = '';
            for (let i = 1; i <= 10; i++) {
                html += `
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" name="studentName${i}" placeholder="ชื่อ-นามสกุล นักเรียนคนที่ ${i}">
                        </div>
                        <div class="col-md-4">
                            <select class="form-control" name="studentGrade${i}">
                                <option value="">เลือกชั้น</option>
                                <option value="อนุบาล">อนุบาล</option>
                                <option value="ป.1">ป.1</option>
                                <option value="ป.2">ป.2</option>
                                <option value="ป.3">ป.3</option>
                                <option value="ป.4">ป.4</option>
                                <option value="ป.5">ป.5</option>
                                <option value="ป.6">ป.6</option>
                            </select>
                        </div>
                    </div>
                `;
            }
            
            $('#studentInputs').html(html);
            $('#addStudentModal').modal('show');
        }

        async function addStudents() {
            showLoading();
            
            const students = [];
            for (let i = 1; i <= 10; i++) {
                const name = $(`input[name="studentName${i}"]`).val().trim();
                const grade = $(`select[name="studentGrade${i}"]`).val();
                
                if (name && grade) {
                    students.push({
                        id: Date.now() + i,
                        name: name,
                        grade: grade
                    });
                }
            }
            
            if (students.length === 0) {
                hideLoading();
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'กรุณากรอกข้อมูลนักเรียนอย่างน้อย 1 คน'
                });
                return;
            }
            
            try {
                const params = new URLSearchParams();
                params.append('action', 'addStudents');
                params.append('sheetId', SHEET_ID);
                params.append('students', JSON.stringify(students));
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    studentsData.push(...students);
                    loadStudents();
                    $('#addStudentModal').modal('hide');
                    $('#addStudentForm')[0].reset();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'เพิ่มนักเรียนสำเร็จ',
                        text: `เพิ่มนักเรียน ${students.length} คน`,
                        timer: 2000
                    });
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            }
            
            hideLoading();
        }

        function editStudent(studentId) {
            if (!currentUser) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเข้าสู่ระบบ',
                    text: 'คุณต้องเข้าสู่ระบบก่อนเพื่อแก้ไขข้อมูล'
                });
                return;
            }
            
            const student = studentsData.find(s => s.id == studentId);
            if (student) {
                $('#editStudentId').val(student.id);
                $('#editStudentName').val(student.name);
                $('#editStudentGrade').val(student.grade);
                $('#editStudentModal').modal('show');
            }
        }

        async function updateStudent() {
            showLoading();
            
            const studentId = $('#editStudentId').val();
            const name = $('#editStudentName').val();
            const grade = $('#editStudentGrade').val();
            
            try {
                const params = new URLSearchParams();
                params.append('action', 'updateStudent');
                params.append('sheetId', SHEET_ID);
                params.append('studentId', studentId);
                params.append('name', name);
                params.append('grade', grade);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const studentIndex = studentsData.findIndex(s => s.id == studentId);
                    if (studentIndex !== -1) {
                        studentsData[studentIndex].name = name;
                        studentsData[studentIndex].grade = grade;
                    }
                    
                    loadStudents();
                    $('#editStudentModal').modal('hide');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'แก้ไขข้อมูลสำเร็จ',
                        timer: 2000
                    });
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            }
            
            hideLoading();
        }

        async function deleteStudent(studentId) {
            if (!currentUser) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเข้าสู่ระบบ',
                    text: 'คุณต้องเข้าสู่ระบบก่อนเพื่อลบข้อมูล'
                });
                return;
            }
            
            const result = await Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบนักเรียนคนนี้หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            });
            
            if (result.isConfirmed) {
                showLoading();
                
                try {
                    const params = new URLSearchParams();
                    params.append('action', 'deleteStudent');
                    params.append('sheetId', SHEET_ID);
                    params.append('studentId', studentId);
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: params
                    });
                    
                    const apiResult = await response.json();
                    
                    if (apiResult.success) {
                        studentsData = studentsData.filter(s => s.id != studentId);
                        loadStudents();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'ลบข้อมูลสำเร็จ',
                            timer: 2000
                        });
                    } else {
                        throw new Error(apiResult.message);
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: error.message
                    });
                }
                
                hideLoading();
            }
        }

        // Transaction Management
        function loadTransactions() {
            let filteredTransactions = transactionsData;
            
            // Filter by user role
            if (currentUserRole === 'teacher') {
                const userGrade = users[currentUser].grade;
                filteredTransactions = transactionsData.filter(t => {
                    const student = studentsData.find(s => s.name === t.studentName);
                    return student && student.grade === userGrade;
                });
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            let html = '';
            paginatedTransactions.forEach(transaction => {
                const student = studentsData.find(s => s.name === transaction.studentName);
                const balance = calculateStudentBalance(transaction.studentName);
                
                html += `
                    <tr>
                        <td>${formatDate(transaction.date)}</td>
                        <td>${transaction.studentName}</td>
                        <td>${student ? student.grade : '-'}</td>
                        <td>
                            <span class="badge ${transaction.type === 'ฝาก' || transaction.type === 'ยกมา' ? 'bg-success' : 'bg-warning'}">
                                ${transaction.type}
                            </span>
                        </td>
                        <td>${parseFloat(transaction.amount).toLocaleString()} บาท</td>
                        <td>${balance.toLocaleString()} บาท</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editTransaction('${transaction.id}')">
                                <i class="las la-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${transaction.id}')">
                                <i class="las la-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            $('#transactionTableBody').html(html);
            updateTransactionPagination(filteredTransactions.length);
        }

        function updateTransactionPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            let html = '';
            
            for (let i = 1; i <= totalPages; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changeTransactionPage(${i})">${i}</a>
                    </li>
                `;
            }
            
            $('#transactionPagination').html(html);
        }

        function changeTransactionPage(page) {
            currentPage = page;
            loadTransactions();
        }

        function showMigrateModal() {
            if (!currentUser) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเข้าสู่ระบบ',
                    text: 'คุณต้องเข้าสู่ระบบก่อนเพื่อใช้งานระบบ'
                });
                return;
            }
            
            const userGrade = users[currentUser].grade;
            let filteredStudents = studentsData;
            
            if (currentUserRole === 'teacher') {
                filteredStudents = studentsData.filter(s => s.grade === userGrade);
            }
            
            let html = '';
            filteredStudents.forEach(student => {
                html += `
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <span>${student.name} (${student.grade})</span>
                        </div>
                        <div class="col-md-6">
                            <input type="number" class="form-control" name="migrate_${student.id}" placeholder="จำนวนเงินเริ่มต้น" min="0" step="0.01">
                        </div>
                    </div>
                `;
            });
            
            $('#migrateStudents').html(html);
            $('#migrateModal').modal('show');
        }

        async function migrateStudents() {
            showLoading();
            
            const date = $('#migrateDate').val();
            const transactions = [];
            
            studentsData.forEach(student => {
                const amount = $(`input[name="migrate_${student.id}"]`).val();
                if (amount && parseFloat(amount) > 0) {
                    transactions.push({
                        id: Date.now() + Math.random(),
                        date: date,
                        studentName: student.name,
                        type: 'ยกมา',
                        amount: parseFloat(amount),
                        user: currentUser
                    });
                }
            });
            
            if (transactions.length === 0) {
                hideLoading();
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'กรุณากรอกจำนวนเงินอย่างน้อย 1 รายการ'
                });
                return;
            }
            
            try {
                const params = new URLSearchParams();
                params.append('action', 'addTransactions');
                params.append('sheetId', SHEET_ID);
                params.append('transactions', JSON.stringify(transactions));
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    transactionsData.push(...transactions);
                    loadTransactions();
                    updateDashboard();
                    $('#migrateModal').modal('hide');
                    $('#migrateForm')[0].reset();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'ยกเงินมาสำเร็จ',
                        text: `บันทึก ${transactions.length} รายการ`,
                        timer: 2000
                    });
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            }
            
            hideLoading();
        }

        function showDepositModal() {
            if (!currentUser) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเข้าสู่ระบบ',
                    text: 'คุณต้องเข้าสู่ระบบก่อนเพื่อใช้งานระบบ'
                });
                return;
            }
            
            const userGrade = users[currentUser].grade;
            let filteredStudents = studentsData;
            
            if (currentUserRole === 'teacher') {
                filteredStudents = studentsData.filter(s => s.grade === userGrade);
            }
            
            let html = '';
            filteredStudents.forEach(student => {
                html += `
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <span>${student.name} (${student.grade})</span>
                        </div>
                        <div class="col-md-6">
                            <input type="number" class="form-control" name="deposit_${student.id}" placeholder="จำนวนเงินฝาก" min="0" step="0.01">
                        </div>
                    </div>
                `;
            });
            
            $('#depositStudents').html(html);
            $('#depositModal').modal('show');
        }

        async function depositMoney() {
            showLoading();
            
            const date = $('#depositDate').val();
            const transactions = [];
            
            studentsData.forEach(student => {
                const amount = $(`input[name="deposit_${student.id}"]`).val();
                if (amount && parseFloat(amount) > 0) {
                    transactions.push({
                        id: Date.now() + Math.random(),
                        date: date,
                        studentName: student.name,
                        type: 'ฝาก',
                        amount: parseFloat(amount),
                        user: currentUser
                    });
                }
            });
            
            if (transactions.length === 0) {
                hideLoading();
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'กรุณากรอกจำนวนเงินอย่างน้อย 1 รายการ'
                });
                return;
            }
            
            try {
                const params = new URLSearchParams();
                params.append('action', 'addTransactions');
                params.append('sheetId', SHEET_ID);
                params.append('transactions', JSON.stringify(transactions));
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    transactionsData.push(...transactions);
                    loadTransactions();
                    updateDashboard();
                    $('#depositModal').modal('hide');
                    $('#depositForm')[0].reset();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'ฝากเงินสำเร็จ',
                        text: `บันทึก ${transactions.length} รายการ`,
                        timer: 2000
                    });
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            }
            
            hideLoading();
        }

        function showWithdrawModal() {
            if (!currentUser) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเข้าสู่ระบบ',
                    text: 'คุณต้องเข้าสู่ระบบก่อนเพื่อใช้งานระบบ'
                });
                return;
            }
            
            const userGrade = users[currentUser].grade;
            let filteredStudents = studentsData;
            
            if (currentUserRole === 'teacher') {
                filteredStudents = studentsData.filter(s => s.grade === userGrade);
            }
            
            let html = '';
            filteredStudents.forEach(student => {
                const balance = calculateStudentBalance(student.name);
                html += `
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <span>${student.name} (${student.grade})</span>
                            <br><small class="text-muted">ยอดคงเหลือ: ${balance.toLocaleString()} บาท</small>
                        </div>
                        <div class="col-md-6">
                            <input type="number" class="form-control" name="withdraw_${student.id}" placeholder="จำนวนเงินถอน" min="0" max="${balance}" step="0.01">
                        </div>
                    </div>
                `;
            });
            
            $('#withdrawStudents').html(html);
            $('#withdrawModal').modal('show');
        }

        async function withdrawMoney() {
            showLoading();
            
            const date = $('#withdrawDate').val();
            const transactions = [];
            
            studentsData.forEach(student => {
                const amount = $(`input[name="withdraw_${student.id}"]`).val();
                const balance = calculateStudentBalance(student.name);
                
                if (amount && parseFloat(amount) > 0) {
                    if (parseFloat(amount) > balance) {
                        hideLoading();
                        Swal.fire({
                            icon: 'error',
                            title: 'จำนวนเงินไม่เพียงพอ',
                            text: `${student.name} มียอดคงเหลือ ${balance.toLocaleString()} บาท`
                        });
                        return;
                    }
                    
                    transactions.push({
                        id: Date.now() + Math.random(),
                        date: date,
                        studentName: student.name,
                        type: 'ถอน',
                        amount: parseFloat(amount),
                        user: currentUser
                    });
                }
            });
            
            if (transactions.length === 0) {
                hideLoading();
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'กรุณากรอกจำนวนเงินอย่างน้อย 1 รายการ'
                });
                return;
            }
            
            try {
                const params = new URLSearchParams();
                params.append('action', 'addTransactions');
                params.append('sheetId', SHEET_ID);
                params.append('transactions', JSON.stringify(transactions));
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    transactionsData.push(...transactions);
                    loadTransactions();
                    updateDashboard();
                    $('#withdrawModal').modal('hide');
                    $('#withdrawForm')[0].reset();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'ถอนเงินสำเร็จ',
                        text: `บันทึก ${transactions.length} รายการ`,
                        timer: 2000
                    });
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            }
            
            hideLoading();
        }

        function editTransaction(transactionId) {
            if (!currentUser) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเข้าสู่ระบบ',
                    text: 'คุณต้องเข้าสู่ระบบก่อนเพื่อแก้ไขข้อมูล'
                });
                return;
            }
            
            const transaction = transactionsData.find(t => t.id == transactionId);
            if (transaction) {
                $('#editTransactionId').val(transaction.id);
                $('#editTransactionDate').val(transaction.date);
                $('#editTransactionAmount').val(transaction.amount);
                $('#editTransactionModal').modal('show');
            }
        }

        async function updateTransaction() {
            showLoading();
            
            const transactionId = $('#editTransactionId').val();
            const date = $('#editTransactionDate').val();
            const amount = $('#editTransactionAmount').val();
            
            try {
                const params = new URLSearchParams();
                params.append('action', 'updateTransaction');
                params.append('sheetId', SHEET_ID);
                params.append('transactionId', transactionId);
                params.append('date', date);
                params.append('amount', amount);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const transactionIndex = transactionsData.findIndex(t => t.id == transactionId);
                    if (transactionIndex !== -1) {
                        transactionsData[transactionIndex].date = date;
                        transactionsData[transactionIndex].amount = parseFloat(amount);
                    }
                    
                    loadTransactions();
                    updateDashboard();
                    $('#editTransactionModal').modal('hide');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'แก้ไขรายการสำเร็จ',
                        timer: 2000
                    });
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message
                });
            }
            
            hideLoading();
        }

        async function deleteTransaction(transactionId) {
            if (!currentUser) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเข้าสู่ระบบ',
                    text: 'คุณต้องเข้าสู่ระบบก่อนเพื่อลบข้อมูล'
                });
                return;
            }
            
            const result = await Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบรายการนี้หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            });
            
            if (result.isConfirmed) {
                showLoading();
                
                try {
                    const params = new URLSearchParams();
                    params.append('action', 'deleteTransaction');
                    params.append('sheetId', SHEET_ID);
                    params.append('transactionId', transactionId);
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: params
                    });
                    
                    const apiResult = await response.json();
                    
                    if (apiResult.success) {
                        transactionsData = transactionsData.filter(t => t.id != transactionId);
                        loadTransactions();
                        updateDashboard();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'ลบรายการสำเร็จ',
                            timer: 2000
                        });
                    } else {
                        throw new Error(apiResult.message);
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: error.message
                    });
                }
                
                hideLoading();
            }
        }

        // Export Functions
        function showExportModal() {
            if (!currentUser) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเข้าสู่ระบบ',
                    text: 'คุณต้องเข้าสู่ระบบก่อนเพื่อ Export ข้อมูล'
                });
                return;
            }
            
            // Show admin options if user is admin
            if (currentUserRole === 'admin') {
                $('#adminExportOptions').show();
            } else {
                $('#adminExportOptions').hide();
            }
            
            $('#exportModal').modal('show');
        }

        function generatePreview() {
            const startDate = $('#exportStartDate').val();
            const endDate = $('#exportEndDate').val();
            const exportFormat = $('#exportFormat').val() || 'student';
            
            if (!startDate || !endDate) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกวันที่',
                    text: 'กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด'
                });
                return;
            }
            
            const exportData = generateExportData(startDate, endDate, exportFormat);
            const previewHtml = generatePreviewHtml(exportData, startDate, endDate, exportFormat);
            
            $('#exportPreview').html(previewHtml).show();
        }

        function generateExportData(startDate, endDate, exportFormat = 'student') {
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T23:59:59');
            
            // Filter transactions by date range
            let filteredTransactions = transactionsData.filter(t => {
                const transactionDate = new Date(t.date + 'T00:00:00');
                return transactionDate >= start && transactionDate <= end;
            });
            
            // Filter by user role
            if (currentUserRole === 'teacher') {
                const userGrade = users[currentUser].grade;
                filteredTransactions = filteredTransactions.filter(t => {
                    const student = studentsData.find(s => s.name === t.studentName);
                    return student && student.grade === userGrade;
                });
            }
            
            // Get unique dates in range
            const dates = [];
            const currentDate = new Date(startDate + 'T00:00:00');
            const endDateObj = new Date(endDate + 'T00:00:00');
            while (currentDate <= endDateObj) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            if (exportFormat === 'grade' && currentUserRole === 'admin') {
                // Grade-based export for admin
                const grades = ['อนุบาล', 'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6'];
                const gradeData = {};
                
                grades.forEach(grade => {
                    gradeData[grade] = {
                        dailyAmounts: {},
                        totalAmount: 0,
                        currentBalance: 0
                    };
                    
                    dates.forEach(dateStr => {
                        gradeData[grade].dailyAmounts[dateStr] = 0;
                    });
                });
                
                // Fill in transaction data by grade
                filteredTransactions.forEach(transaction => {
                    const student = studentsData.find(s => s.name === transaction.studentName);
                    if (student && gradeData[student.grade]) {
                        const dateStr = transaction.date;
                        let amount = parseFloat(transaction.amount);
                        
                        if (transaction.type === 'ถอน') {
                            amount = -amount;
                        }
                        
                        if (gradeData[student.grade].dailyAmounts.hasOwnProperty(dateStr)) {
                            gradeData[student.grade].dailyAmounts[dateStr] += amount;
                        }
                    }
                });
                
                // Calculate totals and current balances
                grades.forEach(grade => {
                    const gradeInfo = gradeData[grade];
                    gradeInfo.totalAmount = Object.values(gradeInfo.dailyAmounts).reduce((sum, amount) => sum + amount, 0);
                    
                    // Calculate current balance for this grade (all transactions up to end date)
                    const gradeStudents = studentsData.filter(s => s.grade === grade);
                    gradeInfo.currentBalance = 0;
                    gradeStudents.forEach(student => {
                        gradeInfo.currentBalance += calculateStudentBalance(student.name);
                    });
                });
                
                return {
                    grades: gradeData,
                    dates: dates,
                    startDate: startDate,
                    endDate: endDate,
                    exportFormat: 'grade'
                };
            } else {
                // Student-based export (default)
                let students = studentsData;
                if (currentUserRole === 'teacher') {
                    const userGrade = users[currentUser].grade;
                    students = studentsData.filter(s => s.grade === userGrade);
                }
                
                // Group by student and date
                const studentData = {};
                students.forEach(student => {
                    studentData[student.name] = {
                        grade: student.grade,
                        dailyAmounts: {},
                        totalAmount: 0,
                        currentBalance: 0
                    };
                    
                    dates.forEach(dateStr => {
                        studentData[student.name].dailyAmounts[dateStr] = 0;
                    });
                });
                
                // Fill in transaction data
                filteredTransactions.forEach(transaction => {
                    if (studentData[transaction.studentName]) {
                        const dateStr = transaction.date;
                        let amount = parseFloat(transaction.amount);
                        
                        if (transaction.type === 'ถอน') {
                            amount = -amount;
                        }
                        
                        if (studentData[transaction.studentName].dailyAmounts.hasOwnProperty(dateStr)) {
                            studentData[transaction.studentName].dailyAmounts[dateStr] += amount;
                        }
                    }
                });
                
                // Calculate totals and current balances
                Object.keys(studentData).forEach(studentName => {
                    const student = studentData[studentName];
                    student.totalAmount = Object.values(student.dailyAmounts).reduce((sum, amount) => sum + amount, 0);
                    student.currentBalance = calculateStudentBalance(studentName);
                });
                
                return {
                    students: studentData,
                    dates: dates,
                    startDate: startDate,
                    endDate: endDate,
                    exportFormat: 'student'
                };
            }
        }

        function generatePreviewHtml(exportData, startDate, endDate, exportFormat = 'student') {
            let html = `
                <div style="text-align: center; margin-bottom: 20px; font-family: 'Sarabun', sans-serif;">
                    <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" style="width: 60px; height: 60px;">
                    <h3>โรงเรียนบ้านกิ่วพร้าว</h3>
                    <h4>รายงานการออมทรัพย์นักเรียน${exportFormat === 'grade' ? ' (รายชั้น)' : ''}</h4>
                    <p>ระหว่างวันที่ ${formatDateThai(startDate)} ถึง ${formatDateThai(endDate)}</p>
                </div>
                
                <table class="table table-bordered" style="font-family: 'Sarabun', sans-serif; font-size: 14px;">
                    <thead>
                        <tr>
                            <th rowspan="2">ลำดับ</th>
                            <th rowspan="2">${exportFormat === 'grade' ? 'ชั้น' : 'ชื่อ-นามสกุล'}</th>
            `;
            
            // Date headers
            exportData.dates.forEach(dateStr => {
                html += `<th>${formatDateThai(dateStr)}</th>`;
            });
            
            html += `
                            <th rowspan="2">ยอดรวม</th>
                            <th rowspan="2">ยอดรวมทั้งสิ้น</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (exportFormat === 'grade') {
                // Grade rows
                let rowIndex = 1;
                Object.keys(exportData.grades).forEach(gradeName => {
                    const grade = exportData.grades[gradeName];
                    html += `
                        <tr>
                            <td>${rowIndex++}</td>
                            <td>${gradeName}</td>
                    `;
                    
                    exportData.dates.forEach(dateStr => {
                        const amount = grade.dailyAmounts[dateStr] || 0;
                        html += `<td>${amount !== 0 ? amount.toLocaleString() : '-'}</td>`;
                    });
                    
                    html += `<td><strong>${grade.totalAmount.toLocaleString()}</strong></td>`;
                    html += `<td><strong>${grade.currentBalance.toLocaleString()}</strong></td></tr>`;
                });
                
                // Total row
                html += `<tr style="background-color: #f8f9fa; font-weight: bold;">
                            <td colspan="2">รวมทั้งสิ้น</td>`;
                
                exportData.dates.forEach(dateStr => {
                    let dailyTotal = 0;
                    Object.keys(exportData.grades).forEach(gradeName => {
                        dailyTotal += exportData.grades[gradeName].dailyAmounts[dateStr] || 0;
                    });
                    html += `<td>${dailyTotal !== 0 ? dailyTotal.toLocaleString() : '-'}</td>`;
                });
                
                const grandTotal = Object.keys(exportData.grades).reduce((sum, gradeName) => {
                    return sum + exportData.grades[gradeName].totalAmount;
                }, 0);
                
                const grandCurrentBalance = Object.keys(exportData.grades).reduce((sum, gradeName) => {
                    return sum + exportData.grades[gradeName].currentBalance;
                }, 0);
                
                html += `<td>${grandTotal.toLocaleString()}</td>`;
                html += `<td>${grandCurrentBalance.toLocaleString()}</td></tr>`;
            } else {
                // Student rows
                let rowIndex = 1;
                Object.keys(exportData.students).forEach(studentName => {
                    const student = exportData.students[studentName];
                    html += `
                        <tr>
                            <td>${rowIndex++}</td>
                            <td>${studentName}</td>
                    `;
                    
                    exportData.dates.forEach(dateStr => {
                        const amount = student.dailyAmounts[dateStr] || 0;
                        html += `<td>${amount !== 0 ? amount.toLocaleString() : '-'}</td>`;
                    });
                    
                    html += `<td><strong>${student.totalAmount.toLocaleString()}</strong></td>`;
                    html += `<td><strong>${student.currentBalance.toLocaleString()}</strong></td></tr>`;
                });
                
                // Total row
                html += `<tr style="background-color: #f8f9fa; font-weight: bold;">
                            <td colspan="2">รวมทั้งสิ้น</td>`;
                
                exportData.dates.forEach(dateStr => {
                    let dailyTotal = 0;
                    Object.keys(exportData.students).forEach(studentName => {
                        dailyTotal += exportData.students[studentName].dailyAmounts[dateStr] || 0;
                    });
                    html += `<td>${dailyTotal !== 0 ? dailyTotal.toLocaleString() : '-'}</td>`;
                });
                
                const grandTotal = Object.keys(exportData.students).reduce((sum, studentName) => {
                    return sum + exportData.students[studentName].totalAmount;
                }, 0);
                
                const grandCurrentBalance = Object.keys(exportData.students).reduce((sum, studentName) => {
                    return sum + exportData.students[studentName].currentBalance;
                }, 0);
                
                html += `<td>${grandTotal.toLocaleString()}</td>`;
                html += `<td>${grandCurrentBalance.toLocaleString()}</td></tr>`;
            }
            
            html += `</tbody></table>`;
            
            return html;
        }

        function exportToExcel() {
            const startDate = $('#exportStartDate').val();
            const endDate = $('#exportEndDate').val();
            const exportFormat = $('#exportFormat').val() || 'student';
            
            if (!startDate || !endDate) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกวันที่',
                    text: 'กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด'
                });
                return;
            }
            
            const exportData = generateExportData(startDate, endDate, exportFormat);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare data for Excel
            const wsData = [];
            
            // Header rows
            wsData.push(['โรงเรียนบ้านกิ่วพร้าว']);
            wsData.push([`รายงานการออมทรัพย์นักเรียน${exportFormat === 'grade' ? ' (รายชั้น)' : ''}`]);
            wsData.push([`ระหว่างวันที่ ${formatDateThai(startDate)} ถึง ${formatDateThai(endDate)}`]);
            wsData.push([]); // Empty row
            
            // Table headers
            const headerRow = ['ลำดับ', exportFormat === 'grade' ? 'ชั้น' : 'ชื่อ-นามสกุล'];
            exportData.dates.forEach(dateStr => {
                headerRow.push(formatDateThai(dateStr));
            });
            headerRow.push('ยอดรวม');
            headerRow.push('ยอดรวมทั้งสิ้น');
            wsData.push(headerRow);
            
            if (exportFormat === 'grade') {
                // Grade data
                let rowIndex = 1;
                Object.keys(exportData.grades).forEach(gradeName => {
                    const grade = exportData.grades[gradeName];
                    const row = [rowIndex++, gradeName];
                    
                    exportData.dates.forEach(dateStr => {
                        const amount = grade.dailyAmounts[dateStr] || 0;
                        row.push(amount !== 0 ? amount : '');
                    });
                    
                    row.push(grade.totalAmount);
                    row.push(grade.currentBalance);
                    wsData.push(row);
                });
                
                // Total row
                const totalRow = ['', 'รวมทั้งสิ้น'];
                exportData.dates.forEach(dateStr => {
                    let dailyTotal = 0;
                    Object.keys(exportData.grades).forEach(gradeName => {
                        dailyTotal += exportData.grades[gradeName].dailyAmounts[dateStr] || 0;
                    });
                    totalRow.push(dailyTotal !== 0 ? dailyTotal : '');
                });
                
                const grandTotal = Object.keys(exportData.grades).reduce((sum, gradeName) => {
                    return sum + exportData.grades[gradeName].totalAmount;
                }, 0);
                
                const grandCurrentBalance = Object.keys(exportData.grades).reduce((sum, gradeName) => {
                    return sum + exportData.grades[gradeName].currentBalance;
                }, 0);
                
                totalRow.push(grandTotal);
                totalRow.push(grandCurrentBalance);
                wsData.push(totalRow);
            } else {
                // Student data
                let rowIndex = 1;
                Object.keys(exportData.students).forEach(studentName => {
                    const student = exportData.students[studentName];
                    const row = [rowIndex++, studentName];
                    
                    exportData.dates.forEach(dateStr => {
                        const amount = student.dailyAmounts[dateStr] || 0;
                        row.push(amount !== 0 ? amount : '');
                    });
                    
                    row.push(student.totalAmount);
                    row.push(student.currentBalance);
                    wsData.push(row);
                });
                
                // Total row
                const totalRow = ['', 'รวมทั้งสิ้น'];
                exportData.dates.forEach(dateStr => {
                    let dailyTotal = 0;
                    Object.keys(exportData.students).forEach(studentName => {
                        dailyTotal += exportData.students[studentName].dailyAmounts[dateStr] || 0;
                    });
                    totalRow.push(dailyTotal !== 0 ? dailyTotal : '');
                });
                
                const grandTotal = Object.keys(exportData.students).reduce((sum, studentName) => {
                    return sum + exportData.students[studentName].totalAmount;
                }, 0);
                
                const grandCurrentBalance = Object.keys(exportData.students).reduce((sum, studentName) => {
                    return sum + exportData.students[studentName].currentBalance;
                }, 0);
                
                totalRow.push(grandTotal);
                totalRow.push(grandCurrentBalance);
                wsData.push(totalRow);
            }
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Add to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'รายงานการออมทรัพย์');
            
            // Save file
            const formatText = exportFormat === 'grade' ? '_รายชั้น' : '';
            const fileName = `รายงานการออมทรัพย์${formatText}_${startDate}_${endDate}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            Swal.fire({
                icon: 'success',
                title: 'Export สำเร็จ',
                text: 'ไฟล์ Excel ถูกดาวน์โหลดแล้ว',
                timer: 2000
            });
        }

        function exportToImage() {
            const startDate = $('#exportStartDate').val();
            const endDate = $('#exportEndDate').val();
            const exportFormat = $('#exportFormat').val() || 'student';
            
            if (!startDate || !endDate) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกวันที่',
                    text: 'กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด'
                });
                return;
            }
            
            const exportData = generateExportData(startDate, endDate, exportFormat);
            const previewHtml = generatePreviewHtml(exportData, startDate, endDate, exportFormat);
            
            // Create temporary div for image generation
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = previewHtml;
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.width = '29.7cm';
            tempDiv.style.backgroundColor = 'white';
            tempDiv.style.padding = '20px';
            tempDiv.style.fontFamily = 'Sarabun, sans-serif';
            tempDiv.style.fontSize = '16pt';
            
            document.body.appendChild(tempDiv);
            
            html2canvas(tempDiv, {
                scale: 2,
                useCORS: true,
                backgroundColor: 'white'
            }).then(canvas => {
                // Create download link
                const link = document.createElement('a');
                const formatText = exportFormat === 'grade' ? '_รายชั้น' : '';
                link.download = `รายงานการออมทรัพย์${formatText}_${startDate}_${endDate}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                // Remove temporary div
                document.body.removeChild(tempDiv);
                
                Swal.fire({
                    icon: 'success',
                    title: 'Export สำเร็จ',
                    text: 'ไฟล์รูปภาพถูกดาวน์โหลดแล้ว',
                    timer: 2000
                });
            });
        }

        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH');
        }

        function formatDateThai(dateString) {
            const date = new Date(dateString);
            const months = [
                'ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
                'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'
            ];
            
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear() + 543;
            
            return `${day} ${month} ${year.toString().substr(-2)}`;
        }

        function showLoading() {
            $('#loadingOverlay').show();
        }

        function hideLoading() {
            $('#loadingOverlay').hide();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9648d3d846087328',t:'MTc1MzQxNjgzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
