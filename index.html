<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบออมทรัพย์นักเรียน - โรงเรียนบ้านกิ่วพร้าว</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- jQuery Validate -->
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- html2canvas for image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-purple: #9b7cb6;
            --light-purple: #e8dff0;
            --dark-purple: #7a5a94;
            --text-dark: #2c3e50;
            --bg-light: #f8f9fa;
        }

        * {
            font-family: 'Sarabun', sans-serif;
        }

        .navbar-brand, .card-title, .btn {
            font-family: 'Kanit', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--light-purple) 0%, #ffffff 100%);
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(90deg, var(--primary-purple), var(--dark-purple)) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 600;
            color: white !important;
        }

        .nav-link {
            color: rgba(255,255,255,0.9) !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            color: white !important;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(155, 124, 182, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(155, 124, 182, 0.25);
        }

        .card-header {
            background: linear-gradient(45deg, var(--primary-purple), var(--dark-purple));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-purple), var(--dark-purple));
            border: none;
            border-radius: 10px;
            font-weight: 500;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 124, 182, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 10px;
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
            border: none;
            border-radius: 10px;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #ff9800);
            border: none;
            border-radius: 10px;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid var(--light-purple);
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 0.2rem rgba(155, 124, 182, 0.25);
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
        }

        .table thead th {
            background: var(--primary-purple);
            color: white;
            border: none;
            font-weight: 600;
        }

        .table tbody tr:hover {
            background-color: var(--light-purple);
        }

        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(45deg, var(--primary-purple), var(--dark-purple));
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--primary-purple), var(--dark-purple));
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Kanit', sans-serif;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-purple);
            border-top: 5px solid var(--primary-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .school-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .login-card {
            max-width: 400px;
            margin: 50px auto;
        }

        .export-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            background: white;
        }

        @media (max-width: 768px) {
            .stats-number {
                font-size: 1.8rem;
            }
            
            .card {
                margin-bottom: 20px;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" alt="โรงเรียนบ้านกิ่วพร้าว" class="school-logo me-3">
                ระบบออมทรัพย์นักเรียน - โรงเรียนบ้านกิ่วพร้าว
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showPage('dashboard')">
                            <img src="https://img.icons8.com/fluency/24/dashboard.png" class="me-2">แดชบอร์ด
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('transaction')">
                            <img src="https://img.icons8.com/fluency/24/money-transfer.png" class="me-2">ฝาก-ถอน
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('students')">
                            <img src="https://img.icons8.com/fluency/24/student-male.png" class="me-2">รายชื่อนักเรียน
                        </a>
                    </li>
                    <li class="nav-item" id="loginNav">
                        <a class="nav-link" href="#" onclick="showLoginModal()">
                            <img src="https://img.icons8.com/color/24/login-rounded-right.png" class="me-2">เข้าสู่ระบบ
                        </a>
                    </li>
                    <li class="nav-item" id="logoutNav" style="display: none;">
                        <a class="nav-link" href="#" onclick="logout()">
                            <img src="https://img.icons8.com/color/24/logout-rounded-left.png" class="me-2">ออกจากระบบ
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page-content">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <img src="https://img.icons8.com/fluency/32/dashboard.png" class="me-2">
                                แดshboard ระบบออมทรัพย์
                            </h5>
                            <div class="d-flex gap-2">
                                <select id="filterType" class="form-select" style="width: auto;" onchange="updateDashboard()">
                                    <option value="all">ทั้งหมด</option>
                                    <option value="monthly">รายเดือน</option>
                                </select>
                                <select id="monthFilter" class="form-select" style="width: auto; display: none;" onchange="updateDashboard()">
                                    <option value="1">มกราคม</option>
                                    <option value="2">กุมภาพันธ์</option>
                                    <option value="3">มีนาคม</option>
                                    <option value="4">เมษายน</option>
                                    <option value="5">พฤษภาคม</option>
                                    <option value="6">มิถุนายน</option>
                                    <option value="7">กรกฎาคม</option>
                                    <option value="8">สิงหาคม</option>
                                    <option value="9">กันยายน</option>
                                    <option value="10">ตุลาคม</option>
                                    <option value="11">พฤศจิกายน</option>
                                    <option value="12">ธันวาคม</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <canvas id="savingsChart" width="400" height="200"></canvas>
                                </div>
                                <div class="col-md-4">
                                    <div class="stats-card mb-3">
                                        <div class="stats-number" id="totalAmount">0</div>
                                        <div>ยอดรวมทั้งหมด (บาท)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Class Summary Cards -->
            <div class="row" id="classCards">
                <!-- Cards will be generated dynamically -->
            </div>
        </div>

        <!-- Transaction Page -->
        <div id="transactionPage" class="page-content" style="display: none;">
            <div id="loginRequired" class="text-center py-5">
                <img src="https://img.icons8.com/fluency/96/lock.png" class="mb-3">
                <h4>กรุณาเข้าสู่ระบบก่อนใช้งาน</h4>
                <button class="btn btn-primary" onclick="showLoginModal()">เข้าสู่ระบบ</button>
            </div>

            <div id="transactionContent" style="display: none;">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <img src="https://img.icons8.com/fluency/32/money-transfer.png" class="me-2">
                                    ระบบฝาก-ถอนเงิน
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <button class="btn btn-success w-100" onclick="showBringForwardModal()">
                                            <img src="https://img.icons8.com/fluency/24/import.png" class="me-2">
                                            ยกมา
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-primary w-100" onclick="showDepositModal()">
                                            <img src="https://img.icons8.com/fluency/24/plus.png" class="me-2">
                                            ฝาก
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-warning w-100" onclick="showWithdrawModal()">
                                            <img src="https://img.icons8.com/fluency/24/minus.png" class="me-2">
                                            ถอน
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-info w-100" onclick="showExportModal()">
                                            <img src="https://img.icons8.com/fluency/24/export.png" class="me-2">
                                            Export ข้อมูล
                                        </button>
                                    </div>
                                </div>

                                <!-- Transaction History Table -->
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>วันที่</th>
                                                <th>ชื่อนักเรียน</th>
                                                <th>ชั้น</th>
                                                <th>ประเภท</th>
                                                <th>จำนวนเงิน</th>
                                                <th>ยอดคงเหลือ</th>
                                                <th>การจัดการ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transactionTableBody">
                                            <!-- Data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <nav>
                                    <ul class="pagination justify-content-center" id="transactionPagination">
                                        <!-- Pagination will be generated here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Page -->
        <div id="studentsPage" class="page-content" style="display: none;">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <img src="https://img.icons8.com/fluency/32/student-male.png" class="me-2">
                                รายชื่อนักเรียน
                            </h5>
                            <button class="btn btn-success" onclick="showAddStudentModal()" id="addStudentBtn" style="display: none;">
                                <img src="https://img.icons8.com/fluency/24/plus.png" class="me-2">
                                เพิ่มนักเรียน
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ลำดับ</th>
                                            <th>ชื่อ-นามสกุล</th>
                                            <th>ชั้น</th>
                                            <th>ยอดเงินปัจจุบัน</th>
                                            <th>การจัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody">
                                        <!-- Data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <nav>
                                <ul class="pagination justify-content-center" id="studentsPagination">
                                    <!-- Pagination will be generated here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เข้าสู่ระบบ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">ชื่อผู้ใช้</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">รหัสผ่าน</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">เข้าสู่ระบบ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bring Forward Modal -->
    <div class="modal fade" id="bringForwardModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ยกเงินมา</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bringForwardForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">วันที่ยกมา</label>
                                <input type="date" class="form-control" id="bringForwardDate" required>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ชื่อนักเรียน</th>
                                        <th>ชั้น</th>
                                        <th>จำนวนเงินเริ่มต้น</th>
                                    </tr>
                                </thead>
                                <tbody id="bringForwardStudentsList">
                                    <!-- Students list will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <button type="submit" class="btn btn-success">บันทึกการยกมา</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal fade" id="depositModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ฝากเงิน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="depositForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">วันที่ฝาก</label>
                                <input type="date" class="form-control" id="depositDate" required>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ชื่อนักเรียน</th>
                                        <th>ยอดปัจจุบัน</th>
                                        <th>จำนวนเงินที่ฝาก</th>
                                    </tr>
                                </thead>
                                <tbody id="depositStudentsList">
                                    <!-- Students list will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <button type="submit" class="btn btn-primary">บันทึกการฝาก</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal fade" id="withdrawModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ถอนเงิน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="withdrawForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">วันที่ถอน</label>
                                <input type="date" class="form-control" id="withdrawDate" required>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ชื่อนักเรียน</th>
                                        <th>ยอดปัจจุบัน</th>
                                        <th>จำนวนเงินที่ถอน</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawStudentsList">
                                    <!-- Students list will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <button type="submit" class="btn btn-warning">บันทึกการถอน</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เพิ่มนักเรียน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div id="studentInputs">
                            <!-- Student inputs will be generated here -->
                        </div>
                        <button type="submit" class="btn btn-success">บันทึก</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Export ข้อมูล</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">วันที่เริ่มต้น</label>
                            <input type="date" class="form-control" id="exportStartDate">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">วันที่สิ้นสุด</label>
                            <input type="date" class="form-control" id="exportEndDate">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-info mt-4" onclick="generateExportPreview()">แสดงตัวอย่าง</button>
                        </div>
                    </div>
                    
                    <div class="export-preview" id="exportPreview">
                        <!-- Preview will be shown here -->
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-success me-2" onclick="exportToImage()">
                            <img src="https://img.icons8.com/fluency/24/image.png" class="me-2">
                            Export เป็นรูปภาพ
                        </button>
                        <button class="btn btn-primary" onclick="exportToExcel()">
                            <img src="https://img.icons8.com/fluency/24/microsoft-excel-2019.png" class="me-2">
                            Export เป็น Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal fade" id="editTransactionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">แก้ไขรายการ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editTransactionForm">
                        <input type="hidden" id="editTransactionId">
                        <div class="mb-3">
                            <label class="form-label">วันที่</label>
                            <input type="date" class="form-control" id="editTransactionDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">จำนวนเงิน</label>
                            <input type="number" class="form-control" id="editTransactionAmount" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-primary">บันทึกการแก้ไข</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">แก้ไขข้อมูลนักเรียน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <div class="mb-3">
                            <label class="form-label">ชื่อ-นามสกุล</label>
                            <input type="text" class="form-control" id="editStudentName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ชั้น</label>
                            <select class="form-select" id="editStudentGrade" required>
                                <option value="">เลือกชั้น</option>
                                <option value="อนุบาล">อนุบาล</option>
                                <option value="ป.1">ป.1</option>
                                <option value="ป.2">ป.2</option>
                                <option value="ป.3">ป.3</option>
                                <option value="ป.4">ป.4</option>
                                <option value="ป.5">ป.5</option>
                                <option value="ป.6">ป.6</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">บันทึกการแก้ไข</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let currentUser = null;
        let currentPage = 1;
        let itemsPerPage = 15;
        let studentsPerPage = 20;
        let studentsData = [];
        let transactionsData = [];
        let savingsChart = null;

        // API Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbwySl3wROBkw7ByEl9B9QgVvO3J0ePDL6AVoklDcRlkH4z1bLvJa0cuZJYPPF5_0iIMpA/exec';
        const SHEET_ID = '1ldRZCuBqsWS7MJd5KCCY3ZiDrsO2V-wxbYVuOYIvZto';

        // User credentials
        const users = {
            'P1': { password: 'p1123456', grade: 'ป.1', role: 'teacher' },
            'P2': { password: 'p2123456', grade: 'ป.2', role: 'teacher' },
            'P3': { password: 'p3123456', grade: 'ป.3', role: 'teacher' },
            'P4': { password: 'p4123456', grade: 'ป.4', role: 'teacher' },
            'P5': { password: 'p5123456', grade: 'ป.5', role: 'teacher' },
            'P6': { password: 'p6123456', grade: 'ป.6', role: 'teacher' },
            'K123': { password: 'k123123456', grade: 'อนุบาล', role: 'teacher' },
            'admin': { password: 'admin57030010', grade: 'all', role: 'admin' }
        };

        // Initialize application
        $(document).ready(function() {
            initializeApp();
            loadData();
            setupEventListeners();
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            $('#depositDate, #withdrawDate, #bringForwardDate').val(today);
            
            // Set default month filter to current month
            const currentMonth = new Date().getMonth() + 1;
            $('#monthFilter').val(currentMonth);
        });

        function initializeApp() {
            showPage('dashboard');
            updateDashboard();
        }

        function setupEventListeners() {
            // Login form
            $('#loginForm').on('submit', handleLogin);
            
            // Transaction forms
            $('#bringForwardForm').on('submit', handleBringForward);
            $('#depositForm').on('submit', handleDeposit);
            $('#withdrawForm').on('submit', handleWithdraw);
            $('#editTransactionForm').on('submit', handleEditTransaction);
            
            // Student forms
            $('#addStudentForm').on('submit', handleAddStudent);
            $('#editStudentForm').on('submit', handleEditStudent);
            
            // Filter change
            $('#filterType').on('change', function() {
                if ($(this).val() === 'monthly') {
                    $('#monthFilter').show();
                } else {
                    $('#monthFilter').hide();
                }
            });
        }

        // API Functions
        async function apiCall(action, data = {}) {
            showLoading();
            try {
                const params = new URLSearchParams({
                    action: action,
                    sheetId: SHEET_ID,
                    ...data
                });

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params
                });

                const result = await response.json();
                
                if (result.success) {
                    return result.data || result;
                } else {
                    throw new Error(result.error || 'เกิดข้อผิดพลาด');
                }
            } catch (error) {
                console.error('API Error:', error);
                Swal.fire('ข้อผิดพลาด', error.message, 'error');
                return null;
            } finally {
                hideLoading();
            }
        }

        async function loadData() {
            try {
                // Load students
                const students = await apiCall('getStudents');
                if (students) {
                    studentsData = students;
                }

                // Load transactions
                const transactions = await apiCall('getTransactions');
                if (transactions) {
                    transactionsData = transactions;
                }

                // Update displays
                updateDashboard();
                updateStudentsTable();
                updateTransactionTable();
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Authentication
        function handleLogin(e) {
            e.preventDefault();
            
            const username = $('#username').val();
            const password = $('#password').val();
            
            if (users[username] && users[username].password === password) {
                currentUser = {
                    username: username,
                    grade: users[username].grade,
                    role: users[username].role
                };
                
                $('#loginModal').modal('hide');
                $('#loginNav').hide();
                $('#logoutNav').show();
                $('#transactionContent').show();
                $('#loginRequired').hide();
                $('#addStudentBtn').show();
                
                Swal.fire('สำเร็จ', 'เข้าสู่ระบบสำเร็จ', 'success');
                
                // Load class-specific data
                loadClassData();
                
            } else {
                Swal.fire('ข้อผิดพลาด', 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง', 'error');
            }
        }

        function logout() {
            currentUser = null;
            $('#loginNav').show();
            $('#logoutNav').hide();
            $('#transactionContent').hide();
            $('#loginRequired').show();
            $('#addStudentBtn').hide();
            
            Swal.fire('สำเร็จ', 'ออกจากระบบสำเร็จ', 'success');
        }

        function showLoginModal() {
            $('#loginModal').modal('show');
        }

        // Page Navigation
        function showPage(page) {
            $('.page-content').hide();
            $(`#${page}Page`).show();
            
            // Update active nav
            $('.nav-link').removeClass('active');
            $(`.nav-link[onclick="showPage('${page}')"]`).addClass('active');
            
            // Load page-specific data
            if (page === 'dashboard') {
                updateDashboard();
            } else if (page === 'students') {
                updateStudentsTable();
            } else if (page === 'transaction') {
                updateTransactionTable();
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            updateClassCards();
            updateChart();
            updateTotalAmount();
        }

        function updateClassCards() {
            const grades = ['อนุบาล', 'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6'];
            const filterType = $('#filterType').val();
            const selectedMonth = $('#monthFilter').val();
            
            let html = '';
            let totalAmount = 0;
            
            grades.forEach(grade => {
                const gradeStudents = studentsData.filter(s => s.grade === grade);
                let gradeTotal = 0;
                
                gradeStudents.forEach(student => {
                    const studentTransactions = transactionsData.filter(t => t.studentId === student.id);
                    let studentBalance = 0;
                    
                    studentTransactions.forEach(transaction => {
                        const transactionDate = new Date(transaction.date);
                        const transactionMonth = transactionDate.getMonth() + 1;
                        
                        if (filterType === 'all' || transactionMonth == selectedMonth) {
                            if (transaction.type === 'deposit' || transaction.type === 'bringForward') {
                                studentBalance += parseFloat(transaction.amount);
                            } else if (transaction.type === 'withdraw') {
                                studentBalance -= parseFloat(transaction.amount);
                            }
                        }
                    });
                    
                    gradeTotal += studentBalance;
                });
                
                totalAmount += gradeTotal;
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="stats-card">
                            <div class="stats-number">${gradeTotal.toLocaleString()}</div>
                            <div>${grade} (${gradeStudents.length} คน)</div>
                        </div>
                    </div>
                `;
            });
            
            $('#classCards').html(html);
            $('#totalAmount').text(totalAmount.toLocaleString());
        }

        function updateChart() {
            const ctx = document.getElementById('savingsChart').getContext('2d');
            
            if (savingsChart) {
                savingsChart.destroy();
            }
            
            const grades = ['อนุบาล', 'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6'];
            const data = [];
            const filterType = $('#filterType').val();
            const selectedMonth = $('#monthFilter').val();
            
            grades.forEach(grade => {
                const gradeStudents = studentsData.filter(s => s.grade === grade);
                let gradeTotal = 0;
                
                gradeStudents.forEach(student => {
                    const studentTransactions = transactionsData.filter(t => t.studentId === student.id);
                    
                    studentTransactions.forEach(transaction => {
                        const transactionDate = new Date(transaction.date);
                        const transactionMonth = transactionDate.getMonth() + 1;
                        
                        if (filterType === 'all' || transactionMonth == selectedMonth) {
                            if (transaction.type === 'deposit' || transaction.type === 'bringForward') {
                                gradeTotal += parseFloat(transaction.amount);
                            } else if (transaction.type === 'withdraw') {
                                gradeTotal -= parseFloat(transaction.amount);
                            }
                        }
                    });
                });
                
                data.push(gradeTotal);
            });
            
            savingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: grades,
                    datasets: [{
                        label: 'ยอดเงินออม (บาท)',
                        data: data,
                        backgroundColor: 'rgba(155, 124, 182, 0.8)',
                        borderColor: 'rgba(155, 124, 182, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' บาท';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTotalAmount() {
            let total = 0;
            const filterType = $('#filterType').val();
            const selectedMonth = $('#monthFilter').val();
            
            studentsData.forEach(student => {
                const studentTransactions = transactionsData.filter(t => t.studentId === student.id);
                
                studentTransactions.forEach(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const transactionMonth = transactionDate.getMonth() + 1;
                    
                    if (filterType === 'all' || transactionMonth == selectedMonth) {
                        if (transaction.type === 'deposit' || transaction.type === 'bringForward') {
                            total += parseFloat(transaction.amount);
                        } else if (transaction.type === 'withdraw') {
                            total -= parseFloat(transaction.amount);
                        }
                    }
                });
            });
            
            $('#totalAmount').text(total.toLocaleString());
        }

        // Transaction Functions
        async function loadClassData() {
            if (!currentUser) return;
            
            let classStudents = studentsData;
            if (currentUser.role === 'teacher') {
                classStudents = studentsData.filter(s => s.grade === currentUser.grade);
            }
            
            // Update bring forward modal
            updateBringForwardModal(classStudents);
            
            // Update deposit/withdraw modals
            updateDepositWithdrawModals(classStudents);
        }

        function updateBringForwardModal(students) {
            let html = '';
            
            students.forEach(student => {
                html += `
                    <tr>
                        <td>${student.name}</td>
                        <td>${student.grade}</td>
                        <td>
                            <input type="number" class="form-control" 
                                   name="bringAmount_${student.id}" 
                                   min="0" step="0.01" 
                                   data-student-id="${student.id}"
                                   data-student-name="${student.name}"
                                   data-student-grade="${student.grade}">
                        </td>
                    </tr>
                `;
            });
            
            $('#bringForwardStudentsList').html(html);
        }

        function updateDepositWithdrawModals(students) {
            let html = '';
            
            students.forEach(student => {
                const currentBalance = calculateStudentBalance(student.id);
                html += `
                    <tr>
                        <td>${student.name}</td>
                        <td>${currentBalance.toLocaleString()} บาท</td>
                        <td>
                            <input type="number" class="form-control" 
                                   name="amount_${student.id}" 
                                   min="0" step="0.01" 
                                   data-student-id="${student.id}"
                                   data-student-name="${student.name}">
                        </td>
                    </tr>
                `;
            });
            
            $('#depositStudentsList').html(html);
            $('#withdrawStudentsList').html(html);
        }

        function calculateStudentBalance(studentId) {
            const studentTransactions = transactionsData.filter(t => t.studentId === studentId);
            let balance = 0;
            
            studentTransactions.forEach(transaction => {
                if (transaction.type === 'deposit' || transaction.type === 'bringForward') {
                    balance += parseFloat(transaction.amount);
                } else if (transaction.type === 'withdraw') {
                    balance -= parseFloat(transaction.amount);
                }
            });
            
            return balance;
        }

        function showBringForwardModal() {
            if (!currentUser) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเข้าสู่ระบบก่อน', 'error');
                return;
            }
            loadClassData();
            $('#bringForwardModal').modal('show');
        }

        function showDepositModal() {
            if (!currentUser) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเข้าสู่ระบบก่อน', 'error');
                return;
            }
            loadClassData();
            $('#depositModal').modal('show');
        }

        function showWithdrawModal() {
            if (!currentUser) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเข้าสู่ระบบก่อน', 'error');
                return;
            }
            loadClassData();
            $('#withdrawModal').modal('show');
        }

        async function handleBringForward(e) {
            e.preventDefault();
            
            const date = $('#bringForwardDate').val();
            const transactions = [];
            
            if (!date) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเลือกวันที่ยกมา', 'error');
                return;
            }
            
            $('#bringForwardStudentsList input[name^="bringAmount_"]').each(function() {
                const amount = parseFloat($(this).val());
                if (amount > 0) {
                    const studentId = $(this).data('student-id');
                    const studentName = $(this).data('student-name');
                    const studentGrade = $(this).data('student-grade');
                    
                    transactions.push({
                        id: generateId(),
                        studentId: studentId,
                        studentName: studentName,
                        grade: studentGrade,
                        type: 'bringForward',
                        amount: amount,
                        date: date,
                        balance: amount,
                        createdBy: currentUser.username
                    });
                }
            });
            
            if (transactions.length === 0) {
                Swal.fire('ข้อผิดพลาด', 'กรุณากรอกจำนวนเงินที่ต้องการยกมา', 'error');
                return;
            }
            
            for (const transaction of transactions) {
                const result = await apiCall('addTransaction', transaction);
                if (result) {
                    transactionsData.push(transaction);
                }
            }
            
            $('#bringForwardModal').modal('hide');
            $('#bringForwardForm')[0].reset();
            updateTransactionTable();
            updateDashboard();
            Swal.fire('สำเร็จ', `บันทึกการยกเงินมา ${transactions.length} รายการสำเร็จ`, 'success');
        }

        async function handleDeposit(e) {
            e.preventDefault();
            
            const date = $('#depositDate').val();
            const transactions = [];
            
            $('#depositStudentsList input[name^="amount_"]').each(function() {
                const amount = parseFloat($(this).val());
                if (amount > 0) {
                    const studentId = $(this).data('student-id');
                    const studentName = $(this).data('student-name');
                    const student = studentsData.find(s => s.id === studentId);
                    const currentBalance = calculateStudentBalance(studentId);
                    
                    transactions.push({
                        id: generateId(),
                        studentId: studentId,
                        studentName: studentName,
                        grade: student.grade,
                        type: 'deposit',
                        amount: amount,
                        date: date,
                        balance: currentBalance + amount,
                        createdBy: currentUser.username
                    });
                }
            });
            
            if (transactions.length === 0) {
                Swal.fire('ข้อผิดพลาด', 'กรุณากรอกจำนวนเงินที่ต้องการฝาก', 'error');
                return;
            }
            
            for (const transaction of transactions) {
                const result = await apiCall('addTransaction', transaction);
                if (result) {
                    transactionsData.push(transaction);
                }
            }
            
            $('#depositModal').modal('hide');
            $('#depositForm')[0].reset();
            updateTransactionTable();
            updateDashboard();
            Swal.fire('สำเร็จ', `บันทึกการฝากเงิน ${transactions.length} รายการสำเร็จ`, 'success');
        }

        async function handleWithdraw(e) {
            e.preventDefault();
            
            const date = $('#withdrawDate').val();
            const transactions = [];
            
            $('#withdrawStudentsList input[name^="amount_"]').each(function() {
                const amount = parseFloat($(this).val());
                if (amount > 0) {
                    const studentId = $(this).data('student-id');
                    const studentName = $(this).data('student-name');
                    const student = studentsData.find(s => s.id === studentId);
                    const currentBalance = calculateStudentBalance(studentId);
                    
                    if (amount > currentBalance) {
                        Swal.fire('ข้อผิดพลาด', `${studentName} มีเงินไม่เพียงพอสำหรับการถอน`, 'error');
                        return false;
                    }
                    
                    transactions.push({
                        id: generateId(),
                        studentId: studentId,
                        studentName: studentName,
                        grade: student.grade,
                        type: 'withdraw',
                        amount: amount,
                        date: date,
                        balance: currentBalance - amount,
                        createdBy: currentUser.username
                    });
                }
            });
            
            if (transactions.length === 0) {
                Swal.fire('ข้อผิดพลาด', 'กรุณากรอกจำนวนเงินที่ต้องการถอน', 'error');
                return;
            }
            
            for (const transaction of transactions) {
                const result = await apiCall('addTransaction', transaction);
                if (result) {
                    transactionsData.push(transaction);
                }
            }
            
            $('#withdrawModal').modal('hide');
            $('#withdrawForm')[0].reset();
            updateTransactionTable();
            updateDashboard();
            Swal.fire('สำเร็จ', `บันทึกการถอนเงิน ${transactions.length} รายการสำเร็จ`, 'success');
        }

        function updateTransactionTable() {
            let filteredTransactions = transactionsData;
            
            // Filter by user role
            if (currentUser && currentUser.role === 'teacher') {
                filteredTransactions = transactionsData.filter(t => {
                    const student = studentsData.find(s => s.id === t.studentId);
                    return student && student.grade === currentUser.grade;
                });
            }
            
            // Sort by date (newest first)
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            let html = '';
            pageTransactions.forEach(transaction => {
                const typeText = {
                    'deposit': 'ฝาก',
                    'withdraw': 'ถอน',
                    'bringForward': 'ยกมา'
                };
                
                const typeClass = {
                    'deposit': 'text-success',
                    'withdraw': 'text-danger',
                    'bringForward': 'text-info'
                };
                
                html += `
                    <tr>
                        <td>${formatThaiDate(transaction.date)}</td>
                        <td>${transaction.studentName}</td>
                        <td>${transaction.grade}</td>
                        <td><span class="${typeClass[transaction.type]}">${typeText[transaction.type]}</span></td>
                        <td>${parseFloat(transaction.amount).toLocaleString()} บาท</td>
                        <td>${parseFloat(transaction.balance).toLocaleString()} บาท</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editTransaction('${transaction.id}')">
                                <img src="https://img.icons8.com/fluency/16/edit.png">
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${transaction.id}')">
                                <img src="https://img.icons8.com/fluency/16/delete.png">
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            $('#transactionTableBody').html(html);
            
            // Update pagination
            updateTransactionPagination(filteredTransactions.length);
        }

        function updateTransactionPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            let html = '';
            
            // Previous button
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changeTransactionPage(${currentPage - 1})">ก่อนหน้า</a>
                </li>
            `;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changeTransactionPage(${i})">${i}</a>
                    </li>
                `;
            }
            
            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changeTransactionPage(${currentPage + 1})">ถัดไป</a>
                </li>
            `;
            
            $('#transactionPagination').html(html);
        }

        function changeTransactionPage(page) {
            const totalPages = Math.ceil(transactionsData.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                updateTransactionTable();
            }
        }

        async function editTransaction(transactionId) {
            const transaction = transactionsData.find(t => t.id === transactionId);
            if (!transaction) return;
            
            $('#editTransactionId').val(transaction.id);
            $('#editTransactionDate').val(transaction.date);
            $('#editTransactionAmount').val(transaction.amount);
            
            $('#editTransactionModal').modal('show');
        }

        async function handleEditTransaction(e) {
            e.preventDefault();
            
            const transactionId = $('#editTransactionId').val();
            const date = $('#editTransactionDate').val();
            const amount = parseFloat($('#editTransactionAmount').val());
            
            const transactionIndex = transactionsData.findIndex(t => t.id === transactionId);
            if (transactionIndex === -1) return;
            
            const updatedTransaction = {
                ...transactionsData[transactionIndex],
                date: date,
                amount: amount
            };
            
            const result = await apiCall('updateTransaction', updatedTransaction);
            
            if (result) {
                transactionsData[transactionIndex] = updatedTransaction;
                $('#editTransactionModal').modal('hide');
                updateTransactionTable();
                updateDashboard();
                Swal.fire('สำเร็จ', 'แก้ไขรายการสำเร็จ', 'success');
            }
        }

        async function deleteTransaction(transactionId) {
            const result = await Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบรายการนี้หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            });
            
            if (result.isConfirmed) {
                const apiResult = await apiCall('deleteTransaction', { id: transactionId });
                
                if (apiResult) {
                    transactionsData = transactionsData.filter(t => t.id !== transactionId);
                    updateTransactionTable();
                    updateDashboard();
                    Swal.fire('สำเร็จ', 'ลบรายการสำเร็จ', 'success');
                }
            }
        }

        // Student Management Functions
        function updateStudentsTable() {
            // Sort students by grade and name
            const sortedStudents = [...studentsData].sort((a, b) => {
                const gradeOrder = ['อนุบาล', 'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6'];
                const gradeA = gradeOrder.indexOf(a.grade);
                const gradeB = gradeOrder.indexOf(b.grade);
                
                if (gradeA !== gradeB) {
                    return gradeA - gradeB;
                }
                
                return a.name.localeCompare(b.name, 'th');
            });
            
            // Pagination
            const startIndex = (currentPage - 1) * studentsPerPage;
            const endIndex = startIndex + studentsPerPage;
            const pageStudents = sortedStudents.slice(startIndex, endIndex);
            
            let html = '';
            pageStudents.forEach((student, index) => {
                const currentBalance = calculateStudentBalance(student.id);
                html += `
                    <tr>
                        <td>${startIndex + index + 1}</td>
                        <td>${student.name}</td>
                        <td>${student.grade}</td>
                        <td>${currentBalance.toLocaleString()} บาท</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editStudent('${student.id}')" ${!currentUser ? 'style="display:none"' : ''}>
                                <img src="https://img.icons8.com/fluency/16/edit.png">
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStudent('${student.id}')" ${!currentUser ? 'style="display:none"' : ''}>
                                <img src="https://img.icons8.com/fluency/16/delete.png">
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            $('#studentsTableBody').html(html);
            
            // Update pagination
            updateStudentsPagination(sortedStudents.length);
        }

        function updateStudentsPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / studentsPerPage);
            let html = '';
            
            // Previous button
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changeStudentsPage(${currentPage - 1})">ก่อนหน้า</a>
                </li>
            `;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changeStudentsPage(${i})">${i}</a>
                    </li>
                `;
            }
            
            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changeStudentsPage(${currentPage + 1})">ถัดไป</a>
                </li>
            `;
            
            $('#studentsPagination').html(html);
        }

        function changeStudentsPage(page) {
            const totalPages = Math.ceil(studentsData.length / studentsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                updateStudentsTable();
            }
        }

        function showAddStudentModal() {
            if (!currentUser) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเข้าสู่ระบบก่อน', 'error');
                return;
            }
            
            // Generate 10 student input rows
            let html = '';
            for (let i = 1; i <= 10; i++) {
                html += `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">ชื่อ-นามสกุล คนที่ ${i}</label>
                            <input type="text" class="form-control" name="studentName${i}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ชั้น</label>
                            <select class="form-select" name="studentGrade${i}">
                                <option value="">เลือกชั้น</option>
                                <option value="อนุบาล">อนุบาล</option>
                                <option value="ป.1">ป.1</option>
                                <option value="ป.2">ป.2</option>
                                <option value="ป.3">ป.3</option>
                                <option value="ป.4">ป.4</option>
                                <option value="ป.5">ป.5</option>
                                <option value="ป.6">ป.6</option>
                            </select>
                        </div>
                    </div>
                `;
            }
            
            $('#studentInputs').html(html);
            $('#addStudentModal').modal('show');
        }

        async function handleAddStudent(e) {
            e.preventDefault();
            
            const students = [];
            
            for (let i = 1; i <= 10; i++) {
                const name = $(`input[name="studentName${i}"]`).val().trim();
                const grade = $(`select[name="studentGrade${i}"]`).val();
                
                if (name && grade) {
                    students.push({
                        id: generateId(),
                        name: name,
                        grade: grade,
                        createdBy: currentUser.username
                    });
                }
            }
            
            if (students.length === 0) {
                Swal.fire('ข้อผิดพลาด', 'กรุณากรอกข้อมูลนักเรียนอย่างน้อย 1 คน', 'error');
                return;
            }
            
            for (const student of students) {
                const result = await apiCall('addStudent', student);
                if (result) {
                    studentsData.push(student);
                }
            }
            
            $('#addStudentModal').modal('hide');
            $('#addStudentForm')[0].reset();
            updateStudentsTable();
            updateDashboard();
            Swal.fire('สำเร็จ', `เพิ่มนักเรียน ${students.length} คนสำเร็จ`, 'success');
        }

        async function editStudent(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;
            
            $('#editStudentId').val(student.id);
            $('#editStudentName').val(student.name);
            $('#editStudentGrade').val(student.grade);
            
            $('#editStudentModal').modal('show');
        }

        async function handleEditStudent(e) {
            e.preventDefault();
            
            const studentId = $('#editStudentId').val();
            const name = $('#editStudentName').val();
            const grade = $('#editStudentGrade').val();
            
            const studentIndex = studentsData.findIndex(s => s.id === studentId);
            if (studentIndex === -1) return;
            
            const updatedStudent = {
                ...studentsData[studentIndex],
                name: name,
                grade: grade
            };
            
            const result = await apiCall('updateStudent', updatedStudent);
            
            if (result) {
                studentsData[studentIndex] = updatedStudent;
                $('#editStudentModal').modal('hide');
                updateStudentsTable();
                updateDashboard();
                Swal.fire('สำเร็จ', 'แก้ไขข้อมูลนักเรียนสำเร็จ', 'success');
            }
        }

        async function deleteStudent(studentId) {
            const result = await Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบนักเรียนคนนี้หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            });
            
            if (result.isConfirmed) {
                const apiResult = await apiCall('deleteStudent', { id: studentId });
                
                if (apiResult) {
                    studentsData = studentsData.filter(s => s.id !== studentId);
                    // Also remove related transactions
                    transactionsData = transactionsData.filter(t => t.studentId !== studentId);
                    updateStudentsTable();
                    updateTransactionTable();
                    updateDashboard();
                    Swal.fire('สำเร็จ', 'ลบนักเรียนสำเร็จ', 'success');
                }
            }
        }

        // Export Functions
        function showExportModal() {
            if (!currentUser) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเข้าสู่ระบบก่อน', 'error');
                return;
            }
            
            // Set default date range (current month)
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            $('#exportStartDate').val(firstDay.toISOString().split('T')[0]);
            $('#exportEndDate').val(lastDay.toISOString().split('T')[0]);
            
            $('#exportModal').modal('show');
        }

        function generateExportPreview() {
            const startDate = new Date($('#exportStartDate').val());
            const endDate = new Date($('#exportEndDate').val());
            
            if (!startDate || !endDate) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเลือกช่วงวันที่', 'error');
                return;
            }
            
            // Get students based on user role
            let exportStudents = studentsData;
            if (currentUser.role === 'teacher') {
                exportStudents = studentsData.filter(s => s.grade === currentUser.grade);
            }
            
            // Generate date range
            const dateRange = [];
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                dateRange.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Generate preview table
            let html = `
                <div style="text-align: center; margin-bottom: 20px; font-family: 'Sarabun', sans-serif;">
                    <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" style="width: 60px; height: 60px; margin-bottom: 10px;">
                    <h4>โรงเรียนบ้านกิ่วพร้าว</h4>
                    <h5>รายงานการออมเงิน</h5>
                    <p>ช่วงวันที่ ${formatThaiDate(startDate.toISOString().split('T')[0])} ถึง ${formatThaiDate(endDate.toISOString().split('T')[0])}</p>
                </div>
                <table class="table table-bordered" style="font-family: 'Sarabun', sans-serif; font-size: 14px;">
                    <thead>
                        <tr>
                            <th>ลำดับ</th>
                            <th>ชื่อ-นามสกุล</th>
            `;
            
            // Add date columns
            dateRange.forEach(date => {
                html += `<th>${formatThaiDate(date.toISOString().split('T')[0])}</th>`;
            });
            
            html += `
                            <th>ยอดรวมรายวัน</th>
                            <th>ยอดรวมเดือนนี้</th>
                            <th>ยอดรวมทั้งหมด</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Add student rows
            exportStudents.forEach((student, index) => {
                html += `<tr><td>${index + 1}</td><td>${student.name}</td>`;
                
                let dailyTotal = 0;
                let monthlyTotal = 0;
                const totalBalance = calculateStudentBalance(student.id);
                
                // Add daily amounts
                dateRange.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const dayTransactions = transactionsData.filter(t => 
                        t.studentId === student.id && t.date === dateStr
                    );
                    
                    let dayAmount = 0;
                    dayTransactions.forEach(t => {
                        if (t.type === 'deposit' || t.type === 'bringForward') {
                            dayAmount += parseFloat(t.amount);
                        } else if (t.type === 'withdraw') {
                            dayAmount -= parseFloat(t.amount);
                        }
                    });
                    
                    dailyTotal += dayAmount;
                    html += `<td>${dayAmount > 0 ? dayAmount.toLocaleString() : ''}</td>`;
                });
                
                // Calculate monthly total (current month)
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthTransactions = transactionsData.filter(t => {
                    const tDate = new Date(t.date);
                    return t.studentId === student.id && 
                           tDate.getMonth() === currentMonth && 
                           tDate.getFullYear() === currentYear;
                });
                
                monthTransactions.forEach(t => {
                    if (t.type === 'deposit' || t.type === 'bringForward') {
                        monthlyTotal += parseFloat(t.amount);
                    } else if (t.type === 'withdraw') {
                        monthlyTotal -= parseFloat(t.amount);
                    }
                });
                
                html += `
                    <td>${dailyTotal.toLocaleString()}</td>
                    <td>${monthlyTotal.toLocaleString()}</td>
                    <td>${totalBalance.toLocaleString()}</td>
                </tr>`;
            });
            
            // Add total row
            html += `<tr style="font-weight: bold;"><td colspan="2">รวมทั้งสิ้น</td>`;
            
            // Calculate column totals
            dateRange.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                let dateTotal = 0;
                
                exportStudents.forEach(student => {
                    const dayTransactions = transactionsData.filter(t => 
                        t.studentId === student.id && t.date === dateStr
                    );
                    
                    dayTransactions.forEach(t => {
                        if (t.type === 'deposit' || t.type === 'bringForward') {
                            dateTotal += parseFloat(t.amount);
                        } else if (t.type === 'withdraw') {
                            dateTotal -= parseFloat(t.amount);
                        }
                    });
                });
                
                html += `<td>${dateTotal > 0 ? dateTotal.toLocaleString() : ''}</td>`;
            });
            
            // Calculate totals
            let grandDailyTotal = 0;
            let grandMonthlyTotal = 0;
            let grandTotal = 0;
            
            exportStudents.forEach(student => {
                grandTotal += calculateStudentBalance(student.id);
            });
            
            html += `
                <td>${grandDailyTotal.toLocaleString()}</td>
                <td>${grandMonthlyTotal.toLocaleString()}</td>
                <td>${grandTotal.toLocaleString()}</td>
            </tr>`;
            
            html += '</tbody></table>';
            
            $('#exportPreview').html(html);
        }

        async function exportToImage() {
            const element = document.getElementById('exportPreview');
            if (!element.innerHTML) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาสร้างตัวอย่างก่อน', 'error');
                return;
            }
            
            try {
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                });
                
                const link = document.createElement('a');
                link.download = `รายงานการออมเงิน_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                Swal.fire('สำเร็จ', 'ดาวน์โหลดรูปภาพสำเร็จ', 'success');
            } catch (error) {
                console.error('Export error:', error);
                Swal.fire('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการ export', 'error');
            }
        }

        function exportToExcel() {
            const startDate = new Date($('#exportStartDate').val());
            const endDate = new Date($('#exportEndDate').val());
            
            if (!startDate || !endDate) {
                Swal.fire('ข้อผิดพลาด', 'กรุณาเลือกช่วงวันที่', 'error');
                return;
            }
            
            // Get students based on user role
            let exportStudents = studentsData;
            if (currentUser.role === 'teacher') {
                exportStudents = studentsData.filter(s => s.grade === currentUser.grade);
            }
            
            // Generate date range
            const dateRange = [];
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                dateRange.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Create header
            const headers = ['ลำดับ', 'ชื่อ-นามสกุล'];
            dateRange.forEach(date => {
                headers.push(formatThaiDate(date.toISOString().split('T')[0]));
            });
            headers.push('ยอดรวมรายวัน', 'ยอดรวมเดือนนี้', 'ยอดรวมทั้งหมด');
            
            // Create data rows
            const data = [headers];
            
            exportStudents.forEach((student, index) => {
                const row = [index + 1, student.name];
                
                let dailyTotal = 0;
                let monthlyTotal = 0;
                const totalBalance = calculateStudentBalance(student.id);
                
                // Add daily amounts
                dateRange.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const dayTransactions = transactionsData.filter(t => 
                        t.studentId === student.id && t.date === dateStr
                    );
                    
                    let dayAmount = 0;
                    dayTransactions.forEach(t => {
                        if (t.type === 'deposit' || t.type === 'bringForward') {
                            dayAmount += parseFloat(t.amount);
                        } else if (t.type === 'withdraw') {
                            dayAmount -= parseFloat(t.amount);
                        }
                    });
                    
                    dailyTotal += dayAmount;
                    row.push(dayAmount > 0 ? dayAmount : '');
                });
                
                // Calculate monthly total
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthTransactions = transactionsData.filter(t => {
                    const tDate = new Date(t.date);
                    return t.studentId === student.id && 
                           tDate.getMonth() === currentMonth && 
                           tDate.getFullYear() === currentYear;
                });
                
                monthTransactions.forEach(t => {
                    if (t.type === 'deposit' || t.type === 'bringForward') {
                        monthlyTotal += parseFloat(t.amount);
                    } else if (t.type === 'withdraw') {
                        monthlyTotal -= parseFloat(t.amount);
                    }
                });
                
                row.push(dailyTotal, monthlyTotal, totalBalance);
                data.push(row);
            });
            
            // Add total row
            const totalRow = ['', 'รวมทั้งสิ้น'];
            dateRange.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                let dateTotal = 0;
                
                exportStudents.forEach(student => {
                    const dayTransactions = transactionsData.filter(t => 
                        t.studentId === student.id && t.date === dateStr
                    );
                    
                    dayTransactions.forEach(t => {
                        if (t.type === 'deposit' || t.type === 'bringForward') {
                            dateTotal += parseFloat(t.amount);
                        } else if (t.type === 'withdraw') {
                            dateTotal -= parseFloat(t.amount);
                        }
                    });
                });
                
                totalRow.push(dateTotal > 0 ? dateTotal : '');
            });
            
            let grandTotal = 0;
            exportStudents.forEach(student => {
                grandTotal += calculateStudentBalance(student.id);
            });
            
            totalRow.push('', '', grandTotal);
            data.push(totalRow);
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Add to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'รายงานการออมเงิน');
            
            // Save file
            XLSX.writeFile(wb, `รายงานการออมเงิน_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            Swal.fire('สำเร็จ', 'ดาวน์โหลด Excel สำเร็จ', 'success');
        }

        // Utility Functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatThaiDate(dateString) {
            const date = new Date(dateString);
            const months = [
                'ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
                'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'
            ];
            
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear() + 543;
            
            return `${day} ${month} ${year.toString().substr(-2)}`;
        }

        function showLoading() {
            $('#loadingOverlay').show();
        }

        function hideLoading() {
            $('#loadingOverlay').hide();
        }

        // Initialize sample data for testing
        function initializeSampleData() {
            // Sample students
            studentsData = [
                { id: 's1', name: 'นางสาวสมใจ ใจดี', grade: 'ป.1' },
                { id: 's2', name: 'นายสมชาย ดีใจ', grade: 'ป.1' },
                { id: 's3', name: 'นางสาวสมหญิง สวยงาม', grade: 'ป.2' },
                { id: 's4', name: 'นายสมศักดิ์ เก่งมาก', grade: 'ป.3' },
                { id: 's5', name: 'นางสาวสมปอง น่ารัก', grade: 'อนุบาล' }
            ];
            
            // Sample transactions
            transactionsData = [
                {
                    id: 't1',
                    studentId: 's1',
                    studentName: 'นางสาวสมใจ ใจดี',
                    grade: 'ป.1',
                    type: 'bringForward',
                    amount: 100,
                    date: '2024-01-15',
                    balance: 100,
                    createdBy: 'P1'
                },
                {
                    id: 't2',
                    studentId: 's1',
                    studentName: 'นางสาวสมใจ ใจดี',
                    grade: 'ป.1',
                    type: 'deposit',
                    amount: 50,
                    date: '2024-01-20',
                    balance: 150,
                    createdBy: 'P1'
                }
            ];
        }

        // Initialize sample data if no data is loaded
        setTimeout(() => {
            if (studentsData.length === 0) {
                initializeSampleData();
                updateDashboard();
                updateStudentsTable();
                updateTransactionTable();
            }
        }, 2000);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96389568315174d4',t:'MTc1MzI0NjUwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
