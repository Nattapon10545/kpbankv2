<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบออมทรัพย์นักเรียนโรงเรียนบ้านกิ่วพร้าว</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- html2canvas for image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, set, get, push, remove, update, onValue } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyCrvR1O7k5yJI2hiLmBZ51SbQijQo95S9M",
            authDomain: "kpschoolmoneysaving.firebaseapp.com",
            databaseURL: "https://kpschoolmoneysaving-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kpschoolmoneysaving",
            storageBucket: "kpschoolmoneysaving.firebasestorage.app",
            messagingSenderId: "44102573934",
            appId: "1:44102573934:web:80b51f633817a691d0ab7f",
            measurementId: "G-082NBV6F9N"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions globally available
        window.firebaseDB = {
            database,
            ref,
            set,
            get,
            push,
            remove,
            update,
            onValue
        };
    </script>
    
    <style>
        :root {
            --primary-color: #E95C00;
            --primary-light: #FF8A3D;
            --primary-dark: #CC5200;
            --secondary-color: #f8f9fa;
            --text-dark: #2c3e50;
            --border-color: #dee2e6;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .navbar-brand {
            font-family: 'Kanit', sans-serif;
            font-weight: 600;
        }

        .header-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
        }

        .school-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 10px;
            font-weight: 500;
            padding: 0.5rem 1.5rem;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .nav-pills .nav-link {
            border-radius: 10px;
            margin: 0 0.25rem;
            font-weight: 500;
        }

        .nav-pills .nav-link.active {
            background-color: var(--primary-color);
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .table thead th {
            background: var(--primary-color);
            color: white;
            border: none;
            font-weight: 600;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .grade-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-left: 4px solid var(--primary-color);
        }

        .amount-input {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }

        .amount-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(233, 92, 0, 0.25);
        }

        .modal-header {
            background: var(--primary-color);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .export-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            background: white;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .school-logo {
                width: 60px;
                height: 60px;
            }
            
            .header-section h1 {
                font-size: 1.5rem;
            }
            
            .card-body {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Header Section -->
    <div class="header-section text-center">
        <div class="container">
            <div class="row align-items-center justify-content-center">
                <div class="col-auto">
                    <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" alt="โรงเรียนบ้านกิ่วพร้าว" class="school-logo">
                </div>
                <div class="col-auto">
                    <h1 class="mb-0" style="font-family: 'Kanit', sans-serif;">ระบบออมทรัพย์นักเรียน</h1>
                    <p class="mb-0">โรงเรียนบ้านกิ่วพร้าว</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="container mb-4">
        <ul class="nav nav-pills justify-content-center" id="mainNav">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="showPage('dashboard')">
                    <img src="https://lh3.googleusercontent.com/d/1Dwq1Mw0jbxoh47JgdbMspJBY-bxrP500" alt="แดชบอร์ด" style="width: 20px; height: 20px; margin-right: 8px;">แดชบอร์ด
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showPage('transaction')">
                    <img src="https://lh3.googleusercontent.com/d/1RMpGhSaUzSn3c3TmExEaxWFXwjdi4KPD" alt="ฝาก-ถอน" style="width: 20px; height: 20px; margin-right: 8px;">ฝาก-ถอน
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showPage('students')">
                    <img src="https://lh3.googleusercontent.com/d/16pTv72tLQrmNN44pGtRtQ0rc3vMlH4za" alt="รายชื่อนักเรียน" style="width: 20px; height: 20px; margin-right: 8px;">รายชื่อนักเรียน
                </a>
            </li>
            <li class="nav-item" id="loginNav">
                <a class="nav-link" href="#" onclick="showLoginModal()">
                    <img src="https://lh3.googleusercontent.com/d/1f_N3et33iMSZ0oawDmWXsDj_wUL8FNnk" alt="เข้าสู่ระบบ" style="width: 20px; height: 20px; margin-right: 8px;">เข้าสู่ระบบ
                </a>
            </li>
            <li class="nav-item d-none" id="logoutNav">
                <a class="nav-link" href="#" onclick="logout()">
                    <img src="https://lh3.googleusercontent.com/d/1y4TlXGVr-o8frqclaIU4FYBJoBiFnz-V" alt="ออกจากระบบ" style="width: 20px; height: 20px; margin-right: 8px;">ออกจากระบบ
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page-content">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-filter me-2"></i>ตัวกรองข้อมูล
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <select class="form-select" id="filterType" onchange="updateDashboard()">
                                        <option value="all">ทั้งหมด</option>
                                        <option value="monthly">รายเดือน</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <input type="month" class="form-control" id="filterMonth" onchange="updateDashboard()" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card grade-card">
                        <div class="card-body text-center">
                            <h3 class="text-primary mb-0" id="totalAmount">฿0</h3>
                            <p class="text-muted mb-0">ยอดรวมเงินฝากทั้งหมด</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-chart-line me-2"></i>แผนภูมิยอดเงินฝาก
                            </h5>
                            <canvas id="savingsChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" id="gradeCards">
                <!-- Grade cards will be populated here -->
            </div>
        </div>

        <!-- Transaction Page -->
        <div id="transactionPage" class="page-content d-none">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-exchange-alt me-2"></i>จัดการฝาก-ถอน
                                </h5>
                                <div id="userInfo" class="text-muted"></div>
                            </div>
                            
                            <div id="loginRequired" class="text-center py-5">
                                <i class="fas fa-lock fa-3x text-muted mb-3"></i>
                                <h5>กรุณาเข้าสู่ระบบเพื่อใช้งาน</h5>
                                <button class="btn btn-primary" onclick="showLoginModal()">เข้าสู่ระบบ</button>
                            </div>

                            <div id="transactionControls" class="d-none">
                                <div class="row mb-3">
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-success w-100" onclick="showCarryOverModal()">
                                            <i class="fas fa-arrow-right me-2"></i>ยกมา
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-primary w-100" onclick="showDepositModal()">
                                            <i class="fas fa-plus me-2"></i>ฝาก
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-warning w-100" onclick="showWithdrawModal()">
                                            <i class="fas fa-minus me-2"></i>ถอน
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-info w-100" onclick="showExportModal()">
                                            <i class="fas fa-download me-2"></i>Export
                                        </button>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>วันที่</th>
                                                <th>ชื่อนักเรียน</th>
                                                <th>ชั้น</th>
                                                <th>ประเภท</th>
                                                <th>จำนวนเงิน</th>
                                                <th>การจัดการ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transactionTable">
                                            <!-- Transaction data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>

                                <nav>
                                    <ul class="pagination justify-content-center" id="transactionPagination">
                                        <!-- Pagination will be populated here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Page -->
        <div id="studentsPage" class="page-content d-none">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-users me-2"></i>รายชื่อนักเรียน
                                </h5>
                                <button class="btn btn-primary" onclick="showAddStudentModal()" id="addStudentBtn" style="display: none;">
                                    <i class="fas fa-plus me-2"></i>เพิ่มนักเรียน
                                </button>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ลำดับ</th>
                                            <th>ชื่อ-นามสกุล</th>
                                            <th>ชั้น</th>
                                            <th>ยอดเงิน</th>
                                            <th>การจัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTable">
                                        <!-- Student data will be populated here -->
                                    </tbody>
                                </table>
                            </div>

                            <nav>
                                <ul class="pagination justify-content-center" id="studentsPagination">
                                    <!-- Pagination will be populated here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เข้าสู่ระบบ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">ชื่อผู้ใช้</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">รหัสผ่าน</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="login()">เข้าสู่ระบบ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Carry Over Modal -->
    <div class="modal fade" id="carryOverModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ยกยอดเงินมา</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">วันที่ยกมา</label>
                        <input type="date" class="form-control" id="carryOverDate" required>
                    </div>
                    <div id="carryOverStudents">
                        <!-- Students list will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveCarryOver()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal fade" id="depositModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ฝากเงิน</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">วันที่ฝาก</label>
                        <input type="date" class="form-control" id="depositDate" required>
                    </div>
                    <div id="depositStudents">
                        <!-- Students list will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveDeposit()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal fade" id="withdrawModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ถอนเงิน</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">วันที่ถอน</label>
                        <input type="date" class="form-control" id="withdrawDate" required>
                    </div>
                    <div id="withdrawStudents">
                        <!-- Students list will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveWithdraw()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เพิ่มนักเรียน</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="addStudentForm">
                        <!-- Student input fields will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveStudents()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Export ข้อมูล</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">วันที่เริ่มต้น</label>
                            <input type="date" class="form-control" id="exportStartDate">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">วันที่สิ้นสุด</label>
                            <input type="date" class="form-control" id="exportEndDate">
                        </div>
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-info me-2" onclick="generatePreview()">
                            <i class="fas fa-eye me-2"></i>ดูตัวอย่าง
                        </button>
                        <button class="btn btn-success me-2" onclick="exportToImage()">
                            <i class="fas fa-image me-2"></i>Export รูปภาพ
                        </button>
                        <button class="btn btn-primary" onclick="exportToExcel()">
                            <i class="fas fa-file-excel me-2"></i>Export Excel
                        </button>
                    </div>
                    <div id="exportPreview" class="export-preview">
                        <!-- Preview will be shown here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let currentUser = null;
        let students = [];
        let transactions = [];
        let currentPage = 1;
        let itemsPerPage = 20;
        let savingsChart = null;

        // User credentials
        const users = {
            'P1': { password: 'p1123456', grade: 'ป.1', role: 'teacher' },
            'P2': { password: 'p2123456', grade: 'ป.2', role: 'teacher' },
            'P3': { password: 'p3123456', grade: 'ป.3', role: 'teacher' },
            'P4': { password: 'p4123456', grade: 'ป.4', role: 'teacher' },
            'P5': { password: 'p5123456', grade: 'ป.5', role: 'teacher' },
            'P6': { password: 'p6123456', grade: 'ป.6', role: 'teacher' },
            'K123': { password: 'k123123456', grade: 'อนุบาล', role: 'teacher' },
            'admin': { password: 'admin57030010', grade: 'all', role: 'admin' }
        };

        // Firebase database functions
        async function loadDataFromFirebase() {
            try {
                showLoading();
                
                // Load students
                const studentsSnapshot = await window.firebaseDB.get(window.firebaseDB.ref(window.firebaseDB.database, 'students'));
                if (studentsSnapshot.exists()) {
                    const studentsData = studentsSnapshot.val();
                    students = Object.keys(studentsData).map(key => ({
                        id: key,
                        ...studentsData[key]
                    }));
                } else {
                    students = [];
                }

                // Load transactions
                const transactionsSnapshot = await window.firebaseDB.get(window.firebaseDB.ref(window.firebaseDB.database, 'transactions'));
                if (transactionsSnapshot.exists()) {
                    const transactionsData = transactionsSnapshot.val();
                    transactions = Object.keys(transactionsData).map(key => ({
                        id: key,
                        ...transactionsData[key]
                    }));
                } else {
                    transactions = [];
                }

                hideLoading();
                updateDashboard();
                updateStudentsTable();
                updateTransactionTable();
            } catch (error) {
                console.error('Error loading data from Firebase:', error);
                hideLoading();
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถโหลดข้อมูลจาก Firebase ได้'
                });
            }
        }

        async function saveStudentToFirebase(studentData) {
            try {
                const newStudentRef = window.firebaseDB.push(window.firebaseDB.ref(window.firebaseDB.database, 'students'));
                await window.firebaseDB.set(newStudentRef, studentData);
                return newStudentRef.key;
            } catch (error) {
                console.error('Error saving student to Firebase:', error);
                throw error;
            }
        }

        async function updateStudentInFirebase(studentId, studentData) {
            try {
                await window.firebaseDB.update(window.firebaseDB.ref(window.firebaseDB.database, `students/${studentId}`), studentData);
            } catch (error) {
                console.error('Error updating student in Firebase:', error);
                throw error;
            }
        }

        async function deleteStudentFromFirebase(studentId) {
            try {
                await window.firebaseDB.remove(window.firebaseDB.ref(window.firebaseDB.database, `students/${studentId}`));
            } catch (error) {
                console.error('Error deleting student from Firebase:', error);
                throw error;
            }
        }

        async function saveTransactionToFirebase(transactionData) {
            try {
                const newTransactionRef = window.firebaseDB.push(window.firebaseDB.ref(window.firebaseDB.database, 'transactions'));
                await window.firebaseDB.set(newTransactionRef, transactionData);
                return newTransactionRef.key;
            } catch (error) {
                console.error('Error saving transaction to Firebase:', error);
                throw error;
            }
        }

        async function updateTransactionInFirebase(transactionId, transactionData) {
            try {
                await window.firebaseDB.update(window.firebaseDB.ref(window.firebaseDB.database, `transactions/${transactionId}`), transactionData);
            } catch (error) {
                console.error('Error updating transaction in Firebase:', error);
                throw error;
            }
        }

        async function deleteTransactionFromFirebase(transactionId) {
            try {
                await window.firebaseDB.remove(window.firebaseDB.ref(window.firebaseDB.database, `transactions/${transactionId}`));
            } catch (error) {
                console.error('Error deleting transaction from Firebase:', error);
                throw error;
            }
        }

        // Initialize data
        function initializeData() {
            // Wait for Firebase to be ready
            setTimeout(() => {
                if (window.firebaseDB) {
                    loadDataFromFirebase();
                } else {
                    // Retry after a short delay
                    setTimeout(initializeData, 500);
                }
            }, 100);
        }

        // Show loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Show page
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.add('d-none');
            });

            // Show selected page
            document.getElementById(pageId + 'Page').classList.remove('d-none');

            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update page content
            if (pageId === 'dashboard') {
                updateDashboard();
            } else if (pageId === 'transaction') {
                updateTransactionPage();
            } else if (pageId === 'students') {
                updateStudentsTable();
            }
        }

        // Show login modal
        function showLoginModal() {
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        }

        // Login function
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (users[username] && users[username].password === password) {
                currentUser = {
                    username: username,
                    grade: users[username].grade,
                    role: users[username].role
                };

                // Update UI
                document.getElementById('loginNav').classList.add('d-none');
                document.getElementById('logoutNav').classList.remove('d-none');
                document.getElementById('addStudentBtn').style.display = 'inline-block';

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();

                // Clear form
                document.getElementById('loginForm').reset();

                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'เข้าสู่ระบบสำเร็จ',
                    text: `ยินดีต้อนรับ ${username}`,
                    timer: 2000,
                    showConfirmButton: false
                });

                // Update transaction page
                updateTransactionPage();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'เข้าสู่ระบบไม่สำเร็จ',
                    text: 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง'
                });
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            document.getElementById('loginNav').classList.remove('d-none');
            document.getElementById('logoutNav').classList.add('d-none');
            document.getElementById('addStudentBtn').style.display = 'none';
            updateTransactionPage();

            Swal.fire({
                icon: 'success',
                title: 'ออกจากระบบสำเร็จ',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // Update dashboard
        function updateDashboard() {
            const filterType = document.getElementById('filterType').value;
            const filterMonth = document.getElementById('filterMonth').value;

            // Enable/disable month filter
            document.getElementById('filterMonth').disabled = filterType === 'all';

            // Calculate total amount
            let filteredTransactions = transactions;
            if (filterType === 'monthly' && filterMonth) {
                filteredTransactions = transactions.filter(t => t.date.startsWith(filterMonth));
            }

            const totalAmount = students.reduce((sum, student) => sum + student.balance, 0);
            document.getElementById('totalAmount').textContent = `฿${totalAmount.toLocaleString()}`;

            // Update chart
            updateChart(filteredTransactions);

            // Update grade cards
            updateGradeCards();
        }

        // Update chart
        function updateChart(filteredTransactions) {
            const ctx = document.getElementById('savingsChart').getContext('2d');
            
            if (savingsChart) {
                savingsChart.destroy();
            }

            const grades = ['อนุบาล', 'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6'];
            const gradeAmounts = grades.map(grade => {
                return students.filter(s => s.grade === grade).reduce((sum, s) => sum + s.balance, 0);
            });

            savingsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: grades,
                    datasets: [{
                        label: 'ยอดเงินฝาก (บาท)',
                        data: gradeAmounts,
                        backgroundColor: 'rgba(233, 92, 0, 0.8)',
                        borderColor: 'rgba(233, 92, 0, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '฿' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update grade cards
        function updateGradeCards() {
            const grades = ['อนุบาล', 'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6'];
            const gradeCardsContainer = document.getElementById('gradeCards');
            
            gradeCardsContainer.innerHTML = '';

            if (students.length === 0) {
                gradeCardsContainer.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h5>ยังไม่มีข้อมูลนักเรียน</h5>
                            <p>กรุณาเข้าสู่ระบบและเพิ่มข้อมูลนักเรียนก่อน</p>
                        </div>
                    </div>
                `;
                return;
            }

            grades.forEach(grade => {
                const gradeStudents = students.filter(s => s.grade === grade);
                const gradeAmount = gradeStudents.reduce((sum, s) => sum + s.balance, 0);
                const studentCount = gradeStudents.length;

                const cardHtml = `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card grade-card">
                            <div class="card-body text-center">
                                <h5 class="card-title">${grade}</h5>
                                <h4 class="text-primary">฿${gradeAmount.toLocaleString()}</h4>
                                <p class="text-muted mb-0">${studentCount} คน</p>
                            </div>
                        </div>
                    </div>
                `;
                gradeCardsContainer.innerHTML += cardHtml;
            });
        }

        // Update transaction page
        function updateTransactionPage() {
            if (currentUser) {
                document.getElementById('loginRequired').classList.add('d-none');
                document.getElementById('transactionControls').classList.remove('d-none');
                document.getElementById('userInfo').textContent = `ผู้ใช้: ${currentUser.username} (${currentUser.grade})`;
                updateTransactionTable();
            } else {
                document.getElementById('loginRequired').classList.remove('d-none');
                document.getElementById('transactionControls').classList.add('d-none');
                document.getElementById('userInfo').textContent = '';
            }
        }

        // Update transaction table
        function updateTransactionTable() {
            const tableBody = document.getElementById('transactionTable');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            let filteredTransactions = transactions;
            if (currentUser && currentUser.role === 'teacher') {
                filteredTransactions = transactions.filter(t => t.grade === currentUser.grade);
            }

            // Sort transactions by date (newest first)
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

            tableBody.innerHTML = '';
            
            if (pageTransactions.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fas fa-exchange-alt"></i>
                                <h6>ยังไม่มีรายการทำธุรกรรม</h6>
                                <p class="mb-0">เริ่มต้นด้วยการฝากเงินหรือยกยอดมา</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                pageTransactions.forEach(transaction => {
                    const row = `
                        <tr>
                            <td>${formatDate(transaction.date)}</td>
                            <td>${transaction.studentName}</td>
                            <td>${transaction.grade}</td>
                            <td><span class="badge ${transaction.type === 'ฝาก' ? 'bg-success' : transaction.type === 'ถอน' ? 'bg-warning' : 'bg-info'}">${transaction.type}</span></td>
                            <td>฿${transaction.amount.toLocaleString()}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editTransaction('${transaction.id}')">
                                    <img src="https://lh3.googleusercontent.com/d/1J08fhv8_Lqe1O1YY4nQTSl-0WKNo3FnU" alt="แก้ไข" style="width: 16px; height: 16px;">
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction('${transaction.id}')">
                                    <img src="https://lh3.googleusercontent.com/d/1CE-tDsLaAhEd3TGz877i7N3AIiYRjDlq" alt="ลบ" style="width: 16px; height: 16px;">
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }

            updateTransactionPagination(filteredTransactions.length);
        }

        // Update transaction pagination
        function updateTransactionPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pagination = document.getElementById('transactionPagination');
            
            pagination.innerHTML = '';

            if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                    const pageItem = `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                    pagination.innerHTML += pageItem;
                }
            }
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            updateTransactionTable();
        }

        // Update students table
        function updateStudentsTable() {
            const tableBody = document.getElementById('studentsTable');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            let filteredStudents = students;
            if (currentUser && currentUser.role === 'teacher') {
                filteredStudents = students.filter(s => s.grade === currentUser.grade);
            }

            const pageStudents = filteredStudents.slice(startIndex, endIndex);

            tableBody.innerHTML = '';
            
            if (pageStudents.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h6>ยังไม่มีข้อมูลนักเรียน</h6>
                                <p class="mb-0">กรุณาเข้าสู่ระบบและเพิ่มข้อมูลนักเรียน</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                pageStudents.forEach((student, index) => {
                    const row = `
                        <tr>
                            <td>${startIndex + index + 1}</td>
                            <td>${student.name}</td>
                            <td>${student.grade}</td>
                            <td>฿${student.balance.toLocaleString()}</td>
                            <td>
                                ${currentUser ? `
                                    <button class="btn btn-sm btn-outline-info me-1" onclick="viewStudent('${student.id}')">
                                        <img src="https://lh3.googleusercontent.com/d/13qxaLbH33ivpbfIfrBmylnxINq1oOLFl" alt="ดู" style="width: 16px; height: 16px;">
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editStudent('${student.id}')">
                                        <img src="https://lh3.googleusercontent.com/d/1J08fhv8_Lqe1O1YY4nQTSl-0WKNo3FnU" alt="แก้ไข" style="width: 16px; height: 16px;">
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent('${student.id}')">
                                        <img src="https://lh3.googleusercontent.com/d/1CE-tDsLaAhEd3TGz877i7N3AIiYRjDlq" alt="ลบ" style="width: 16px; height: 16px;">
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }

            updateStudentsPagination(filteredStudents.length);
        }

        // Update students pagination
        function updateStudentsPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pagination = document.getElementById('studentsPagination');
            
            pagination.innerHTML = '';

            if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                    const pageItem = `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changeStudentPage(${i})">${i}</a>
                        </li>
                    `;
                    pagination.innerHTML += pageItem;
                }
            }
        }

        // Change student page
        function changeStudentPage(page) {
            currentPage = page;
            updateStudentsTable();
        }

        // Show carry over modal
        function showCarryOverModal() {
            if (students.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูลนักเรียน',
                    text: 'กรุณาเพิ่มข้อมูลนักเรียนก่อนทำรายการ'
                });
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('carryOverModal'));
            const studentsContainer = document.getElementById('carryOverStudents');
            
            let filteredStudents = students;
            if (currentUser.role === 'teacher') {
                filteredStudents = students.filter(s => s.grade === currentUser.grade);
            }

            studentsContainer.innerHTML = '';
            filteredStudents.forEach(student => {
                const studentHtml = `
                    <div class="row mb-2 align-items-center">
                        <div class="col-md-6">
                            <span>${student.name} (${student.grade})</span>
                        </div>
                        <div class="col-md-6">
                            <input type="number" class="form-control amount-input" 
                                   placeholder="จำนวนเงินเริ่มต้น" 
                                   data-student-id="${student.id}" min="0" step="1">
                        </div>
                    </div>
                `;
                studentsContainer.innerHTML += studentHtml;
            });

            // Set default date to today
            document.getElementById('carryOverDate').value = new Date().toISOString().split('T')[0];
            modal.show();
        }

        // Save carry over
        async function saveCarryOver() {
            showLoading();
            
            try {
                const date = document.getElementById('carryOverDate').value;
                const amountInputs = document.querySelectorAll('#carryOverStudents .amount-input');
                
                const promises = [];
                
                amountInputs.forEach(input => {
                    const studentId = input.dataset.studentId;
                    const amount = parseFloat(input.value) || 0;
                    
                    if (amount > 0) {
                        const student = students.find(s => s.id === studentId);
                        if (student) {
                            // Update student balance in Firebase
                            const updatedData = {
                                name: student.name,
                                grade: student.grade,
                                balance: amount
                            };
                            promises.push(updateStudentInFirebase(studentId, updatedData));
                            
                            // Add transaction record
                            const transaction = {
                                studentName: student.name,
                                grade: student.grade,
                                type: 'ยกมา',
                                amount: amount,
                                date: date
                            };
                            promises.push(saveTransactionToFirebase(transaction));
                        }
                    }
                });

                await Promise.all(promises);
                await loadDataFromFirebase();

                hideLoading();
                bootstrap.Modal.getInstance(document.getElementById('carryOverModal')).hide();
                
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกสำเร็จ',
                    text: 'ยกยอดเงินเริ่มต้นเรียบร้อยแล้ว',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                hideLoading();
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้'
                });
            }
        }

        // Show deposit modal
        function showDepositModal() {
            if (students.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูลนักเรียน',
                    text: 'กรุณาเพิ่มข้อมูลนักเรียนก่อนทำรายการ'
                });
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('depositModal'));
            const studentsContainer = document.getElementById('depositStudents');
            
            let filteredStudents = students;
            if (currentUser.role === 'teacher') {
                filteredStudents = students.filter(s => s.grade === currentUser.grade);
            }

            studentsContainer.innerHTML = '';
            filteredStudents.forEach(student => {
                const studentHtml = `
                    <div class="row mb-2 align-items-center">
                        <div class="col-md-6">
                            <span>${student.name} (${student.grade})</span>
                        </div>
                        <div class="col-md-6">
                            <input type="number" class="form-control amount-input" 
                                   placeholder="จำนวนเงินฝาก" 
                                   data-student-id="${student.id}" min="0" step="1">
                        </div>
                    </div>
                `;
                studentsContainer.innerHTML += studentHtml;
            });

            // Set default date to today
            document.getElementById('depositDate').value = new Date().toISOString().split('T')[0];
            modal.show();
        }

        // Save deposit
        async function saveDeposit() {
            showLoading();
            
            try {
                const date = document.getElementById('depositDate').value;
                const amountInputs = document.querySelectorAll('#depositStudents .amount-input');
                
                const promises = [];
                
                amountInputs.forEach(input => {
                    const studentId = input.dataset.studentId;
                    const amount = parseFloat(input.value) || 0;
                    
                    if (amount > 0) {
                        const student = students.find(s => s.id === studentId);
                        if (student) {
                            // Update student balance in Firebase
                            const updatedData = {
                                name: student.name,
                                grade: student.grade,
                                balance: student.balance + amount
                            };
                            promises.push(updateStudentInFirebase(studentId, updatedData));
                            
                            // Add transaction record
                            const transaction = {
                                studentName: student.name,
                                grade: student.grade,
                                type: 'ฝาก',
                                amount: amount,
                                date: date
                            };
                            promises.push(saveTransactionToFirebase(transaction));
                        }
                    }
                });

                await Promise.all(promises);
                await loadDataFromFirebase();

                hideLoading();
                bootstrap.Modal.getInstance(document.getElementById('depositModal')).hide();
                
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกสำเร็จ',
                    text: 'ฝากเงินเรียบร้อยแล้ว',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                hideLoading();
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้'
                });
            }
        }

        // Show withdraw modal
        function showWithdrawModal() {
            if (students.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูลนักเรียน',
                    text: 'กรุณาเพิ่มข้อมูลนักเรียนก่อนทำรายการ'
                });
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('withdrawModal'));
            const studentsContainer = document.getElementById('withdrawStudents');
            
            let filteredStudents = students;
            if (currentUser.role === 'teacher') {
                filteredStudents = students.filter(s => s.grade === currentUser.grade);
            }

            studentsContainer.innerHTML = '';
            filteredStudents.forEach(student => {
                const studentHtml = `
                    <div class="row mb-2 align-items-center">
                        <div class="col-md-6">
                            <span>${student.name} (${student.grade}) - ยอดคงเหลือ: ฿${student.balance.toLocaleString()}</span>
                        </div>
                        <div class="col-md-6">
                            <input type="number" class="form-control amount-input" 
                                   placeholder="จำนวนเงินถอน" 
                                   data-student-id="${student.id}" 
                                   max="${student.balance}" min="0" step="1">
                        </div>
                    </div>
                `;
                studentsContainer.innerHTML += studentHtml;
            });

            // Set default date to today
            document.getElementById('withdrawDate').value = new Date().toISOString().split('T')[0];
            modal.show();
        }

        // Save withdraw
        async function saveWithdraw() {
            showLoading();
            
            try {
                const date = document.getElementById('withdrawDate').value;
                const amountInputs = document.querySelectorAll('#withdrawStudents .amount-input');
                
                const promises = [];
                
                amountInputs.forEach(input => {
                    const studentId = input.dataset.studentId;
                    const amount = parseFloat(input.value) || 0;
                    
                    if (amount > 0) {
                        const student = students.find(s => s.id === studentId);
                        if (student && student.balance >= amount) {
                            // Update student balance in Firebase
                            const updatedData = {
                                name: student.name,
                                grade: student.grade,
                                balance: student.balance - amount
                            };
                            promises.push(updateStudentInFirebase(studentId, updatedData));
                            
                            // Add transaction record
                            const transaction = {
                                studentName: student.name,
                                grade: student.grade,
                                type: 'ถอน',
                                amount: amount,
                                date: date
                            };
                            promises.push(saveTransactionToFirebase(transaction));
                        }
                    }
                });

                await Promise.all(promises);
                await loadDataFromFirebase();

                hideLoading();
                bootstrap.Modal.getInstance(document.getElementById('withdrawModal')).hide();
                
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกสำเร็จ',
                    text: 'ถอนเงินเรียบร้อยแล้ว',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                hideLoading();
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้'
                });
            }
        }

        // Show add student modal
        function showAddStudentModal() {
            const modal = new bootstrap.Modal(document.getElementById('addStudentModal'));
            const formContainer = document.getElementById('addStudentForm');
            
            formContainer.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const studentHtml = `
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <input type="text" class="form-control" placeholder="ชื่อ-นามสกุล ${i}" id="studentName${i}">
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="studentGrade${i}">
                                <option value="">เลือกชั้น</option>
                                <option value="อนุบาล">อนุบาล</option>
                                <option value="ป.1">ป.1</option>
                                <option value="ป.2">ป.2</option>
                                <option value="ป.3">ป.3</option>
                                <option value="ป.4">ป.4</option>
                                <option value="ป.5">ป.5</option>
                                <option value="ป.6">ป.6</option>
                            </select>
                        </div>
                    </div>
                `;
                formContainer.innerHTML += studentHtml;
            }
            
            modal.show();
        }

        // Save students
        async function saveStudents() {
            showLoading();
            
            try {
                const promises = [];
                
                for (let i = 1; i <= 10; i++) {
                    const name = document.getElementById(`studentName${i}`).value.trim();
                    const grade = document.getElementById(`studentGrade${i}`).value;
                    
                    if (name && grade) {
                        // Check if user can add student to this grade
                        if (currentUser.role === 'teacher' && currentUser.grade !== grade) {
                            continue; // Skip if teacher trying to add student to different grade
                        }
                        
                        const newStudent = {
                            name: name,
                            grade: grade,
                            balance: 0
                        };
                        
                        promises.push(saveStudentToFirebase(newStudent));
                    }
                }

                await Promise.all(promises);
                await loadDataFromFirebase();

                hideLoading();
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกสำเร็จ',
                    text: 'เพิ่มนักเรียนเรียบร้อยแล้ว',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                hideLoading();
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้'
                });
            }
        }

        // View student details
        function viewStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            // Get student transactions
            const studentTransactions = transactions.filter(t => t.studentName === student.name);
            
            let transactionHistory = '<h6>ประวัติการทำรายการ:</h6>';
            if (studentTransactions.length > 0) {
                transactionHistory += '<div class="table-responsive"><table class="table table-sm">';
                transactionHistory += '<thead><tr><th>วันที่</th><th>ประเภท</th><th>จำนวน</th></tr></thead><tbody>';
                
                studentTransactions.forEach(t => {
                    transactionHistory += `<tr>
                        <td>${formatDate(t.date)}</td>
                        <td><span class="badge ${t.type === 'ฝาก' ? 'bg-success' : t.type === 'ถอน' ? 'bg-warning' : 'bg-info'}">${t.type}</span></td>
                        <td>฿${t.amount.toLocaleString()}</td>
                    </tr>`;
                });
                
                transactionHistory += '</tbody></table></div>';
            } else {
                transactionHistory += '<p class="text-muted">ยังไม่มีประวัติการทำรายการ</p>';
            }

            Swal.fire({
                title: 'รายละเอียดนักเรียน',
                html: `
                    <div class="text-start">
                        <p><strong>ชื่อ-นามสกุล:</strong> ${student.name}</p>
                        <p><strong>ชั้น:</strong> ${student.grade}</p>
                        <p><strong>ยอดเงินคงเหลือ:</strong> <span class="text-primary">฿${student.balance.toLocaleString()}</span></p>
                        <hr>
                        ${transactionHistory}
                    </div>
                `,
                width: '600px',
                confirmButtonText: 'ปิด'
            });
        }

        // Edit student
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            // Check permission
            if (currentUser.role === 'teacher' && currentUser.grade !== student.grade) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่มีสิทธิ์',
                    text: 'คุณสามารถแก้ไขได้เฉพาะนักเรียนในชั้นของคุณเท่านั้น'
                });
                return;
            }

            Swal.fire({
                title: 'แก้ไขข้อมูลนักเรียน',
                html: `
                    <input type="text" id="editName" class="swal2-input" placeholder="ชื่อ-นามสกุล" value="${student.name}">
                    <select id="editGrade" class="swal2-select">
                        <option value="อนุบาล" ${student.grade === 'อนุบาล' ? 'selected' : ''}>อนุบาล</option>
                        <option value="ป.1" ${student.grade === 'ป.1' ? 'selected' : ''}>ป.1</option>
                        <option value="ป.2" ${student.grade === 'ป.2' ? 'selected' : ''}>ป.2</option>
                        <option value="ป.3" ${student.grade === 'ป.3' ? 'selected' : ''}>ป.3</option>
                        <option value="ป.4" ${student.grade === 'ป.4' ? 'selected' : ''}>ป.4</option>
                        <option value="ป.5" ${student.grade === 'ป.5' ? 'selected' : ''}>ป.5</option>
                        <option value="ป.6" ${student.grade === 'ป.6' ? 'selected' : ''}>ป.6</option>
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'บันทึก',
                cancelButtonText: 'ยกเลิก',
                preConfirm: () => {
                    const name = document.getElementById('editName').value.trim();
                    const grade = document.getElementById('editGrade').value;
                    
                    if (!name) {
                        Swal.showValidationMessage('กรุณากรอกชื่อ-นามสกุล');
                        return false;
                    }
                    
                    return { name, grade };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading();
                    
                    try {
                        const updatedData = {
                            name: result.value.name,
                            grade: result.value.grade,
                            balance: student.balance
                        };
                        
                        await updateStudentInFirebase(studentId, updatedData);
                        await loadDataFromFirebase();
                        
                        hideLoading();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'แก้ไขสำเร็จ',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } catch (error) {
                        hideLoading();
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถแก้ไขข้อมูลได้'
                        });
                    }
                }
            });
        }

        // Delete student
        function deleteStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            // Check permission
            if (currentUser.role === 'teacher' && currentUser.grade !== student.grade) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่มีสิทธิ์',
                    text: 'คุณสามารถลบได้เฉพาะนักเรียนในชั้นของคุณเท่านั้น'
                });
                return;
            }

            Swal.fire({
                title: 'ยืนยันการลบ',
                text: `คุณต้องการลบ ${student.name} ใช่หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading();
                    
                    try {
                        // Delete student from Firebase
                        await deleteStudentFromFirebase(studentId);
                        
                        // Delete related transactions
                        const studentTransactions = transactions.filter(t => t.studentName === student.name);
                        for (const transaction of studentTransactions) {
                            await deleteTransactionFromFirebase(transaction.id);
                        }
                        
                        await loadDataFromFirebase();
                        
                        hideLoading();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'ลบสำเร็จ',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } catch (error) {
                        hideLoading();
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถลบข้อมูลได้'
                        });
                    }
                }
            });
        }

        // Edit transaction
        function editTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            Swal.fire({
                title: 'แก้ไขรายการ',
                html: `
                    <input type="date" id="editDate" class="swal2-input" value="${transaction.date}">
                    <input type="number" id="editAmount" class="swal2-input" placeholder="จำนวนเงิน" value="${transaction.amount}" min="0" step="1">
                `,
                showCancelButton: true,
                confirmButtonText: 'บันทึก',
                cancelButtonText: 'ยกเลิก',
                preConfirm: () => {
                    const date = document.getElementById('editDate').value;
                    const amount = parseFloat(document.getElementById('editAmount').value);
                    
                    if (!date || !amount || amount <= 0) {
                        Swal.showValidationMessage('กรุณากรอกข้อมูลให้ครบถ้วน');
                        return false;
                    }
                    
                    return { date, amount };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading();
                    
                    try {
                        const oldAmount = transaction.amount;
                        const newAmount = result.value.amount;
                        const student = students.find(s => s.name === transaction.studentName);
                        
                        if (student) {
                            // Adjust student balance
                            let newBalance = student.balance;
                            if (transaction.type === 'ฝาก' || transaction.type === 'ยกมา') {
                                newBalance = newBalance - oldAmount + newAmount;
                            } else if (transaction.type === 'ถอน') {
                                newBalance = newBalance + oldAmount - newAmount;
                            }
                            
                            // Update student balance
                            const updatedStudentData = {
                                name: student.name,
                                grade: student.grade,
                                balance: newBalance
                            };
                            await updateStudentInFirebase(student.id, updatedStudentData);
                        }
                        
                        // Update transaction
                        const updatedTransactionData = {
                            studentName: transaction.studentName,
                            grade: transaction.grade,
                            type: transaction.type,
                            amount: newAmount,
                            date: result.value.date
                        };
                        await updateTransactionInFirebase(transactionId, updatedTransactionData);
                        
                        await loadDataFromFirebase();
                        
                        hideLoading();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'แก้ไขสำเร็จ',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } catch (error) {
                        hideLoading();
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถแก้ไขข้อมูลได้'
                        });
                    }
                }
            });
        }

        // Delete transaction
        function deleteTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            Swal.fire({
                title: 'ยืนยันการลบ',
                text: `คุณต้องการลบรายการ ${transaction.type} ${transaction.amount} บาท ใช่หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    showLoading();
                    
                    try {
                        const student = students.find(s => s.name === transaction.studentName);
                        
                        if (student) {
                            // Adjust student balance
                            let newBalance = student.balance;
                            if (transaction.type === 'ฝาก' || transaction.type === 'ยกมา') {
                                newBalance -= transaction.amount;
                            } else if (transaction.type === 'ถอน') {
                                newBalance += transaction.amount;
                            }
                            
                            // Update student balance
                            const updatedStudentData = {
                                name: student.name,
                                grade: student.grade,
                                balance: newBalance
                            };
                            await updateStudentInFirebase(student.id, updatedStudentData);
                        }
                        
                        // Remove transaction
                        await deleteTransactionFromFirebase(transactionId);
                        
                        await loadDataFromFirebase();
                        
                        hideLoading();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'ลบสำเร็จ',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } catch (error) {
                        hideLoading();
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถลบข้อมูลได้'
                        });
                    }
                }
            });
        }

        // Show export modal
        function showExportModal() {
            if (students.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'ไม่มีข้อมูลสำหรับ Export'
                });
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('exportModal'));
            
            // Set default dates
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('exportStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('exportEndDate').value = today.toISOString().split('T')[0];
            
            modal.show();
        }

        // Generate preview
        function generatePreview() {
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            
            if (!startDate || !endDate) {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณาเลือกช่วงวันที่'
                });
                return;
            }

            const previewContainer = document.getElementById('exportPreview');
            const exportData = generateExportData(startDate, endDate);
            
            previewContainer.innerHTML = `
                <div class="text-center mb-3">
                    <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" alt="โรงเรียนบ้านกิ่วพร้าว" style="width: 60px; height: 60px;">
                    <h5>โรงเรียนบ้านกิ่วพร้าว</h5>
                    <p>รายงานการออมทรัพย์ ระหว่างวันที่ ${formatDateThai(startDate)} ถึง ${formatDateThai(endDate)}</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered" style="font-family: 'Sarabun', sans-serif; font-size: 14px;">
                        ${exportData.html}
                    </table>
                </div>
            `;
        }

        // Generate export data
        function generateExportData(startDate, endDate) {
            let filteredStudents = students;
            if (currentUser.role === 'teacher') {
                filteredStudents = students.filter(s => s.grade === currentUser.grade);
            }

            // Get date range
            const dates = getDateRange(startDate, endDate);
            
            // Generate table header
            let headerHtml = '<thead><tr><th>ลำดับ</th><th>ชื่อ-นามสกุล</th>';
            dates.forEach(date => {
                headerHtml += `<th>${formatDateThai(date)}</th>`;
            });
            headerHtml += '<th>ยอดรวมตามช่วงวันที่</th><th>ยอดรวมทั้งหมด</th></tr></thead>';

            // Generate table body
            let bodyHtml = '<tbody>';
            let columnTotals = new Array(dates.length).fill(0);
            let grandTotal = 0;

            if (currentUser.role === 'admin') {
                // Group by grade for admin
                const grades = ['อนุบาล', 'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6'];
                let rowIndex = 1;

                grades.forEach(grade => {
                    const gradeStudents = students.filter(s => s.grade === grade);
                    if (gradeStudents.length > 0) {
                        let gradeRowTotal = 0;
                        let gradeGrandTotal = gradeStudents.reduce((sum, s) => sum + s.balance, 0);

                        bodyHtml += `<tr><td>${rowIndex++}</td><td><strong>${grade}</strong></td>`;
                        
                        dates.forEach((date, dateIndex) => {
                            const dayTotal = gradeStudents.reduce((sum, student) => {
                                const dayTransactions = transactions.filter(t => 
                                    t.studentName === student.name && t.date === date
                                );
                                return sum + dayTransactions.reduce((tSum, t) => 
                                    t.type === 'ฝาก' || t.type === 'ยกมา' ? tSum + t.amount : tSum - t.amount, 0
                                );
                            }, 0);
                            
                            bodyHtml += `<td>${dayTotal > 0 ? dayTotal.toLocaleString() : ''}</td>`;
                            columnTotals[dateIndex] += dayTotal;
                            gradeRowTotal += dayTotal;
                        });

                        bodyHtml += `<td><strong>${gradeRowTotal.toLocaleString()}</strong></td>`;
                        bodyHtml += `<td><strong>${gradeGrandTotal.toLocaleString()}</strong></td></tr>`;
                        grandTotal += gradeGrandTotal;
                    }
                });
            } else {
                // Individual students for teachers
                filteredStudents.forEach((student, index) => {
                    let rowTotal = 0;
                    bodyHtml += `<tr><td>${index + 1}</td><td>${student.name}</td>`;
                    
                    dates.forEach((date, dateIndex) => {
                        const dayTransactions = transactions.filter(t => 
                            t.studentName === student.name && t.date === date
                        );
                        const dayTotal = dayTransactions.reduce((sum, t) => 
                            t.type === 'ฝาก' || t.type === 'ยกมา' ? sum + t.amount : sum - t.amount, 0
                        );
                        
                        bodyHtml += `<td>${dayTotal > 0 ? dayTotal.toLocaleString() : ''}</td>`;
                        columnTotals[dateIndex] += dayTotal;
                        rowTotal += dayTotal;
                    });

                    bodyHtml += `<td>${rowTotal.toLocaleString()}</td>`;
                    bodyHtml += `<td>${student.balance.toLocaleString()}</td></tr>`;
                    grandTotal += student.balance;
                });
            }

            // Add totals row
            bodyHtml += '<tr><td colspan="2"><strong>รวมทั้งสิ้น</strong></td>';
            columnTotals.forEach(total => {
                bodyHtml += `<td><strong>${total.toLocaleString()}</strong></td>`;
            });
            const periodTotal = columnTotals.reduce((sum, total) => sum + total, 0);
            bodyHtml += `<td><strong>${periodTotal.toLocaleString()}</strong></td>`;
            bodyHtml += `<td><strong>${grandTotal.toLocaleString()}</strong></td></tr>`;
            bodyHtml += '</tbody>';

            return {
                html: headerHtml + bodyHtml,
                data: { filteredStudents, dates, columnTotals, grandTotal }
            };
        }

        // Get date range
        function getDateRange(startDate, endDate) {
            const dates = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                dates.push(d.toISOString().split('T')[0]);
            }
            
            return dates;
        }

        // Format date to Thai
        function formatDateThai(dateString) {
            const date = new Date(dateString);
            const months = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 
                           'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}`;
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH');
        }

        // Export to image
        function exportToImage() {
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            
            if (!startDate || !endDate) {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณาเลือกช่วงวันที่'
                });
                return;
            }

            showLoading();
            
            setTimeout(() => {
                const exportData = generateExportData(startDate, endDate);
                
                // Create a temporary div for export
                const exportDiv = document.createElement('div');
                exportDiv.style.width = '1200px';
                exportDiv.style.padding = '30px';
                exportDiv.style.backgroundColor = 'white';
                exportDiv.style.fontFamily = 'Sarabun, sans-serif';
                exportDiv.style.fontSize = '14px';
                exportDiv.style.lineHeight = '1.4';
                
                exportDiv.innerHTML = `
                    <div style="text-align: center; margin-bottom: 30px; padding: 20px;">
                        <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" alt="โรงเรียนบ้านกิ่วพร้าว" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 15px;">
                        <h2 style="margin: 10px 0; font-size: 24px; font-weight: 600; color: #2c3e50;">โรงเรียนบ้านกิ่วพร้าว</h2>
                        <p style="margin: 5px 0; font-size: 16px; color: #6c757d;">รายงานการออมทรัพย์ ระหว่างวันที่ ${formatDateThai(startDate)} ถึง ${formatDateThai(endDate)}</p>
                    </div>
                    <div style="background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse; font-family: Sarabun, sans-serif; font-size: 14px;">
                            ${exportData.html}
                        </table>
                    </div>
                `;
                
                // Add styles to table
                const table = exportDiv.querySelector('table');
                const headerCells = table.querySelectorAll('thead th');
                const bodyCells = table.querySelectorAll('tbody td');
                
                // Style header cells
                headerCells.forEach(cell => {
                    cell.style.border = '1px solid #dee2e6';
                    cell.style.padding = '12px 8px';
                    cell.style.textAlign = 'center';
                    cell.style.backgroundColor = '#E95C00';
                    cell.style.color = 'white';
                    cell.style.fontWeight = '600';
                    cell.style.fontSize = '14px';
                });
                
                // Style body cells
                bodyCells.forEach((cell, index) => {
                    cell.style.border = '1px solid #dee2e6';
                    cell.style.padding = '10px 8px';
                    cell.style.textAlign = 'center';
                    cell.style.fontSize = '13px';
                    
                    // Alternate row colors
                    const row = Math.floor(index / headerCells.length);
                    if (row % 2 === 0) {
                        cell.style.backgroundColor = '#f8f9fa';
                    } else {
                        cell.style.backgroundColor = 'white';
                    }
                    
                    // Check if this is a totals row
                    if (cell.textContent.includes('รวมทั้งสิ้น') || cell.parentElement.querySelector('strong')) {
                        cell.style.backgroundColor = '#fff3cd';
                        cell.style.fontWeight = '600';
                        cell.style.color = '#856404';
                    }
                });
                
                document.body.appendChild(exportDiv);
                
                html2canvas(exportDiv, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#f5f7fa'
                }).then(canvas => {
                    // Create download link
                    const link = document.createElement('a');
                    link.download = `รายงานการออมทรัพย์_${startDate}_${endDate}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    
                    // Clean up
                    document.body.removeChild(exportDiv);
                    hideLoading();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Export สำเร็จ',
                        text: 'ดาวน์โหลดไฟล์รูปภาพเรียบร้อยแล้ว',
                        timer: 2000,
                        showConfirmButton: false
                    });
                });
            }, 1000);
        }

        // Export to Excel
        function exportToExcel() {
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            
            if (!startDate || !endDate) {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณาเลือกช่วงวันที่'
                });
                return;
            }

            showLoading();
            
            setTimeout(() => {
                const exportData = generateExportData(startDate, endDate);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Prepare data for Excel
                const wsData = [];
                
                // Header
                wsData.push(['โรงเรียนบ้านกิ่วพร้าว']);
                wsData.push([`รายงานการออมทรัพย์ ระหว่างวันที่ ${formatDateThai(startDate)} ถึง ${formatDateThai(endDate)}`]);
                wsData.push([]); // Empty row
                
                // Table header
                const dates = getDateRange(startDate, endDate);
                const headerRow = ['ลำดับ', 'ชื่อ-นามสกุล'];
                dates.forEach(date => {
                    headerRow.push(formatDateThai(date));
                });
                headerRow.push('ยอดรวมตามช่วงวันที่');
                headerRow.push('ยอดรวมทั้งหมด');
                wsData.push(headerRow);
                
                // Data rows
                let filteredStudents = students;
                if (currentUser.role === 'teacher') {
                    filteredStudents = students.filter(s => s.grade === currentUser.grade);
                }

                if (currentUser.role === 'admin') {
                    // Group by grade for admin
                    const grades = ['อนุบาล', 'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6'];
                    let rowIndex = 1;

                    grades.forEach(grade => {
                        const gradeStudents = students.filter(s => s.grade === grade);
                        if (gradeStudents.length > 0) {
                            const row = [rowIndex++, grade];
                            let gradeRowTotal = 0;
                            
                            dates.forEach(date => {
                                const dayTotal = gradeStudents.reduce((sum, student) => {
                                    const dayTransactions = transactions.filter(t => 
                                        t.studentName === student.name && t.date === date
                                    );
                                    return sum + dayTransactions.reduce((tSum, t) => 
                                        t.type === 'ฝาก' || t.type === 'ยกมา' ? tSum + t.amount : tSum - t.amount, 0
                                    );
                                }, 0);
                                
                                row.push(dayTotal > 0 ? dayTotal : '');
                                gradeRowTotal += dayTotal;
                            });

                            row.push(gradeRowTotal);
                            row.push(gradeStudents.reduce((sum, s) => sum + s.balance, 0));
                            wsData.push(row);
                        }
                    });
                } else {
                    // Individual students for teachers
                    filteredStudents.forEach((student, index) => {
                        const row = [index + 1, student.name];
                        let rowTotal = 0;
                        
                        dates.forEach(date => {
                            const dayTransactions = transactions.filter(t => 
                                t.studentName === student.name && t.date === date
                            );
                            const dayTotal = dayTransactions.reduce((sum, t) => 
                                t.type === 'ฝาก' || t.type === 'ยกมา' ? sum + t.amount : sum - t.amount, 0
                            );
                            
                            row.push(dayTotal > 0 ? dayTotal : '');
                            rowTotal += dayTotal;
                        });

                        row.push(rowTotal);
                        row.push(student.balance);
                        wsData.push(row);
                    });
                }

                // Totals row
                const totalsRow = ['', 'รวมทั้งสิ้น'];
                const columnTotals = new Array(dates.length).fill(0);
                
                // Calculate column totals
                for (let i = 4; i < wsData.length - 1; i++) { // Skip header rows and current row
                    for (let j = 2; j < 2 + dates.length; j++) {
                        if (typeof wsData[i][j] === 'number') {
                            columnTotals[j - 2] += wsData[i][j];
                        }
                    }
                }
                
                columnTotals.forEach(total => {
                    totalsRow.push(total);
                });
                
                const periodTotal = columnTotals.reduce((sum, total) => sum + total, 0);
                totalsRow.push(periodTotal);
                
                const grandTotal = filteredStudents.reduce((sum, s) => sum + s.balance, 0);
                totalsRow.push(grandTotal);
                
                wsData.push(totalsRow);
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Set column widths
                const colWidths = [
                    { wch: 8 },  // ลำดับ
                    { wch: 25 }, // ชื่อ-นามสกุล
                ];
                dates.forEach(() => {
                    colWidths.push({ wch: 12 }); // วันที่
                });
                colWidths.push({ wch: 15 }); // ยอดรวมตามช่วงวันที่
                colWidths.push({ wch: 15 }); // ยอดรวมทั้งหมด
                
                ws['!cols'] = colWidths;
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'รายงานการออมทรัพย์');
                
                // Save file
                XLSX.writeFile(wb, `รายงานการออมทรัพย์_${startDate}_${endDate}.xlsx`);
                
                hideLoading();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Export สำเร็จ',
                    text: 'ดาวน์โหลดไฟล์ Excel เรียบร้อยแล้ว',
                    timer: 2000,
                    showConfirmButton: false
                });
            }, 1000);
        }

        // Initialize filter month change
        document.getElementById('filterType').addEventListener('change', function() {
            document.getElementById('filterMonth').disabled = this.value === 'all';
            if (this.value === 'all') {
                document.getElementById('filterMonth').value = '';
            }
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            
            // Set default dates for export
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('exportStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('exportEndDate').value = today.toISOString().split('T')[0];
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96900db2b44b7dc3',t:'MTc1NDE2MzY5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
